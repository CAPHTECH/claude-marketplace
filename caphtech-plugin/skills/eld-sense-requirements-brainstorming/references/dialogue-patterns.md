# 対話フローパターン詳細

要件明確化のための対話パターンと実践ガイド。

## 対話の核心原則

### 1. Epistemic Humility（認識論的謙虚さ）

**原則**: 推測を事実として扱わない。`unknown`と言う勇気を持つ。

```
❌ 悪い例:
Claude: おそらくトークンは1時間有効でしょう。

✅ 良い例:
Claude: トークンの有効期限は決まっていますか？
       決まっていない場合は、セキュリティとUXのバランスから
       提案できます。
```

### 2. Progressive Disclosure（段階的開示）

**原則**: 1度に多くを聞かず、回答に応じて深掘りする。

```
✅ 良い例:
Claude: まず3つの観点で質問します。
       [質問1-3]

User: [回答]

Claude: ありがとうございます。
       [回答1]について、もう少し詳しく確認させてください。
       [深掘り質問]
```

### 3. Concrete Over Abstract（具体性優先）

**原則**: 抽象語を見つけたら必ず具体化する。

```
User: ユーザーが適切に認証されるようにして

❌ 悪い応答:
Claude: 了解です。適切な認証を実装します。

✅ 良い応答:
Claude: 「適切に」の定義を明確にしたいです。
       1. 認証方法: パスワード？OAuth？
       2. 失敗時の挙動: リトライ制限は？
       3. セッション管理: 保持期間は？
```

## 基本対話フロー

### フロー1: 初期質問

```markdown
## Phase 1: カテゴリ選択と予告

Claude:
要件を明確にするため、以下の観点で質問させてください：

1. [カテゴリ1]: [なぜ重要か]
2. [カテゴリ2]: [なぜ重要か]
3. [カテゴリ3]: [なぜ重要か]

各カテゴリ2-3問ずつ質問します。

---

## Phase 2: 質問提示

## 1. [カテゴリ1]

### 質問1: [具体的な質問]
- なぜこれを聞くか: [Law/Term/境界との関係]
- 例:
  - オプション1
  - オプション2
  - オプション3

### 質問2: [具体的な質問]
...

## 2. [カテゴリ2]
...

どこから回答しますか？（順不同で構いません）
```

**ポイント**:
- なぜその質問をするのか理由を明示
- 具体例や選択肢を必ず提示
- 回答の順序を強制しない（心理的ハードルを下げる）

### フロー2: 回答受け取りと記録

```markdown
User: [回答]

Claude:
ありがとうございます。確認させてください：

【明確になった点】
- [Law候補]: [ユーザーの回答から抽出]
- [Term候補]: [ユーザーの回答から抽出]
- [境界条件]: [ユーザーの回答から抽出]

【まだ曖昧な点】
- [回答の中の抽象語や不明点]

[曖昧な点]について、追加で質問してもよろしいですか？
```

**ポイント**:
- 理解した内容を明示的にフィードバック
- Law/Term観点で整理して見せる
- 追加質問の許可を取る（対話のペース調整）

### フロー3: 深掘り質問

```markdown
Claude:
[抽象語/不明点]について、もう少し具体的に教えてください。

例えば：
- ケースA: [具体例1] → どうしますか？
- ケースB: [具体例2] → どうしますか？
```

**ポイント**:
- 抽象語を具体的なケースに分解
- yes/noではなく、選択肢や理由を引き出す

### フロー4: Issue Contract下書き生成

```markdown
Claude:
要件が明確になりました。Issue Contractの下書きを作成します。

## Issue Contract

### 目的 (Goal)
[ビジネス価値と実現内容]

### 不変条件 (Invariants)
- [既存システムで守られている条件]
- [新規実装でも守るべき条件]

### 物差し (Acceptance Criteria)
- [検証可能な成功条件 + Evidence Ladder レベル]

### 停止条件 (Stop Conditions)
- [予測と現実の継続的乖離]
- [観測不能な変更の増加]
- [ロールバック線の崩壊]

### Law/Term候補
**Law:**
- LAW-xxx: [守るべき条件] (Severity: S0/S1/S2)

**Term:**
- TERM-yyy: [語彙の定義] (Type: Entity/Value/Context/Boundary)

### 未確定事項 (Open Questions)
- [まだ決まっていないこと]
- [追加調査が必要なこと]

この下書きで問題ないですか？
修正や追加があれば教えてください。
```

**ポイント**:
- 対話で得た情報をすべて反映
- 未確定事項も正直に記載
- ユーザーに確認を求める

## 対話パターン集

### パターンA: 質問→回答→深掘り

**シナリオ**: 回答が抽象的すぎる場合

```
Claude:
認証方式は何を想定していますか？
- パスワードのみ
- OAuth2.0
- 多要素認証

User:
OAuth2.0で

Claude:
ありがとうございます。OAuth2.0について追加で確認します：

1. プロバイダ: Google/GitHub/独自？
2. スコープ: メールアドレス取得のみ？プロフィール全体？
3. トークン管理: access_token + refresh_tokenの両方使いますか？
```

**ポイント**:
- 回答を受け入れつつ、具体化を求める
- 次の質問が自然につながるようにする

### パターンB: 曖昧さの指摘

**シナリオ**: 抽象語や多義語が含まれる場合

```
User:
ユーザーが適切に認証されるようにして

Claude:
「適切に」の定義を明確にしたいです。

以下の観点で、期待される挙動を教えてください：

1. 認証方法
   - パスワードのみ？
   - OAuth？
   - 多要素認証？

2. 失敗時の挙動
   - リトライ回数制限は？
   - アカウントロックは？

3. セッション管理
   - ログイン状態の保持期間は？
   - 自動ログアウトは？
```

**ポイント**:
- 抽象語を批判せず、「明確にしたい」と伝える
- 具体的な観点に分解して質問

### パターンC: 境界条件の確認

**シナリオ**: エッジケースを確認する場合

```
Claude:
境界条件を確認させてください。

## 入力の範囲
- ユーザー名: 最小/最大文字数は？
- パスワード: 複雑さ要件は？

## 例外ケース
以下のケースはどう扱いますか？

1. 既に同じメールアドレスが存在する
   - エラーにする？
   - 既存アカウントを更新？

2. 空文字列が送信された
   - 拒否？
   - デフォルト値を設定？

3. ネットワークタイムアウト
   - リトライ？
   - エラー通知？
```

**ポイント**:
- 具体的なケースを列挙
- 各ケースに対する期待される挙動を質問

### パターンD: 選択肢の提示

**シナリオ**: 複数のアプローチがある場合

```
Claude:
エラーハンドリングについて、3つのアプローチが考えられます：

## オプション1: Fail Fast（即座に失敗）
- 利点: エラーが早期に検出される
- 欠点: ユーザー体験が悪くなる可能性
- 適用場面: クリティカルな操作

## オプション2: Best Effort（可能な範囲で継続）
- 利点: 部分的な成功でもユーザーに価値を提供
- 欠点: 不整合が発生する可能性
- 適用場面: バッチ処理

## オプション3: Graceful Degradation（段階的機能低下）
- 利点: 外部依存が落ちてもコア機能は提供
- 欠点: フォールバック実装が複雑
- 適用場面: 高可用性が求められるシステム

どのアプローチが適切ですか？
または、操作によって使い分けますか？
```

**ポイント**:
- 各選択肢のトレードオフを説明
- 適用場面を示す
- ユーザーに判断材料を提供

### パターンE: Law/Term候補の確認

**シナリオ**: 対話から Law/Term を抽出した場合

```
Claude:
ここまでの対話から、以下の Law/Term 候補を抽出しました：

## Law候補

**LAW-token-expiry** (Severity: S0)
- 内容: アクセストークンは1時間で失効する
- 根拠: ユーザーの回答「1時間で」
- 違反時: 自動的にリフレッシュトークンで更新

**LAW-failed-login-limit** (Severity: S1)
- 内容: 3回ログイン失敗でアカウント一時ロック
- 根拠: ユーザーの回答「3回失敗でロック」
- 違反時: 管理者通知 + ユーザーへエラー表示

## Term候補

**TERM-authenticated-user** (Type: Context)
- 定義: 有効なアクセストークンを持つユーザー
- 境界: トークン有効期限内

**TERM-access-token** (Type: Value Object)
- 定義: JWT形式の認証トークン
- 有効期限: 1時間

この理解で合っていますか？
```

**ポイント**:
- Law/Term形式で整理して見せる
- ユーザーの回答を根拠として明示
- 誤解がないか確認

### パターンF: 未確定事項の明示

**シナリオ**: すべての質問に答えられない場合

```
User:
外部システムとの連携はまだ決まってない

Claude:
了解です。未確定事項として記録します：

## 未確定事項

**外部システム連携** (Priority: Medium)
- 現状: 未定
- 影響範囲: 認証フロー、データ同期
- 決定期限: いつまでに決める必要がありますか？
- 暫定方針:
  - オプション1: 連携なしで実装開始（後で追加）
  - オプション2: 仮仕様で実装（後で調整）

どちらの方針で進めますか？
```

**ポイント**:
- 未確定を恥じない（Epistemic Humility）
- 影響範囲と優先度を明示
- 暫定方針の選択肢を提示

## 深掘りトリガー

以下の場合、必ず深掘り質問を行う：

### トリガー1: 抽象語の検出

```yaml
抽象語リスト:
  - 適切に、柔軟に、効率的に
  - なるべく、できるだけ
  - 一般的な、標準的な
  - シンプルに、スマートに
```

**対応**: 「[抽象語]の定義を明確にしたいです」

### トリガー2: 例外ケースの未言及

```yaml
確認すべき例外:
  - null/空文字列/0
  - 最大値/最小値オーバー
  - 重複/競合
  - タイムアウト/ネットワークエラー
```

**対応**: 「以下のケースはどう扱いますか？」

### トリガー3: 複数の解釈が可能

```yaml
多義語の例:
  - "ユーザー": 登録ユーザー？ゲスト？管理者？
  - "有効": 期限内？アクティブ？検証済み？
  - "削除": 論理削除？物理削除？
```

**対応**: 「[語]の意味を確認します。X/Y/Zのどれですか？」

### トリガー4: Lawの範囲不明

```yaml
確認すべき範囲:
  - 適用スコープ: 全体？一部？
  - 例外条件: 常に？条件付き？
  - 違反時動作: 拒否？警告？自動修正？
```

**対応**: 「この条件の適用範囲を確認します」

## 完了判定基準

以下をすべて満たしたら対話完了:

### チェックリスト

- [ ] 選択した3カテゴリすべてで質問完了
- [ ] すべての回答が具体的（抽象語が解消されている）
- [ ] Law候補が3つ以上抽出済み
- [ ] Term候補が3つ以上抽出済み
- [ ] Issue Contract下書きが作成済み
- [ ] 未確定事項が明示されている
- [ ] ユーザーが下書きを確認済み

### 抽象語ゼロチェック

Issue Contract内に以下の語がないことを確認:

```
❌ 禁止ワード:
- 適切に、柔軟に、効率的に
- なるべく、できるだけ
- 一般的に、標準的に
- シンプルに、スマートに
```

すべて具体的な条件・数値・ケースに置き換わっていること。

## 対話の終了パターン

### パターン1: 正常終了

```
Claude:
要件の明確化が完了しました！

## 成果物
- Issue Contract下書き ✅
- Law候補: 5個 ✅
- Term候補: 4個 ✅
- 未確定事項: 1個（優先度Low）

次のステップ:
1. `/eld-model` でLaw/Termを詳細化
2. `/eld-sense-planning` でタスク分解

進めてよろしいですか？
```

### パターン2: 部分的完了

```
Claude:
現時点で明確化できた範囲をまとめます：

## 完了した部分
- 認証フロー ✅
- エラーハンドリング ✅

## 未確定事項（要追加調査）
- 外部システム連携仕様
- データ移行方針

未確定事項は後で決まり次第、追加できます。
現時点で進められる範囲で実装を開始しますか？
```

### パターン3: 中断（情報不足）

```
Claude:
以下の情報がないと、安全に実装を進められません：

## クリティカルな未確定事項
1. [項目1]: [なぜ必要か]
2. [項目2]: [なぜ必要か]

これらが決まるまで、実装開始を保留することをお勧めします。
または、仮の仕様で進めますか？（後で手戻りの可能性あり）
```

**ポイント**:
- 無理に進めない（Epistemic Humility）
- リスクを明示
- ユーザーに判断を委ねる
