# Spec 3層構造

## 概要

specを一枚岩にすると破綻する。生成可能性が層で異なるため。

```
層A: インターフェースspec（高精度）
  ↓
層B: 振る舞いspec（中精度）
  ↓
層C: 業務意味spec（低精度・草案のみ）
```

## 層A: インターフェースspec

### 定義

システムの「公開面」を記述。外部から観測可能な構造。

### 抽出対象

| 項目 | 例 | 根拠の強さ |
|------|-----|----------|
| HTTPパス/メソッド | `GET /api/users/:id` | 強（ルーティング定義） |
| リクエスト型 | `{ name: string, age: number }` | 強（型定義/スキーマ） |
| レスポンス型 | `{ id: string, created_at: Date }` | 強（型定義/スキーマ） |
| ステータスコード | `200, 400, 404, 500` | 中（実装依存） |
| エラーコード | `USER_NOT_FOUND`, `INVALID_INPUT` | 中（実装依存） |
| 必須/任意 | `required`, `optional` | 強（バリデーション定義） |
| デフォルト値 | `limit: 10` | 強（デフォルト定義） |
| 列挙値 | `status: 'active' | 'inactive'` | 強（型定義） |

### 生成精度

**高精度で生成可能**

理由:
- 型システムが根拠を提供
- OpenAPI/GraphQL/protobufなどの形式的定義が多い
- テストで検証されていることが多い

### 間違いやすい点

- 実際の返却が型とズレる（例外時だけ別フォーマット）
- バリデーションが分散（デコレータ、ミドルウェア、ドメイン層）
- 動的ルーティング（メタプログラミング）

## 層B: 振る舞いspec

### 定義

システムの「動的振る舞い」を記述。条件・制約・副作用。

### 抽出対象

| 項目 | 例 | 根拠の強さ |
|------|-----|----------|
| 前提条件 | `ユーザーが認証済み` | 中（ガード実装） |
| 事後条件 | `DBにレコードが作成される` | 中（実装追跡） |
| 禁止条件 | `削除済みユーザーは更新不可` | 中（バリデーション） |
| 副作用 | `DB書込み`, `メール送信` | 中（実装追跡） |
| 状態遷移 | `draft → published → archived` | 中（状態管理実装） |
| 冪等性 | `同一リクエストで同一結果` | 低（明示されていないことが多い） |
| リトライ方針 | `3回リトライ後失敗` | 低（設定依存） |

### 生成精度

**中精度で生成可能**

理由:
- コード上で確認できるが、テストで未確認のことがある
- 暗黙の前提が多い
- 相関制約（AがtrueならB必須）の取りこぼしやすい

### 間違いやすい点

- 制約が暗黙（DB制約・外部サービス制約・運用ルール）
- トランザクション境界が読めない
- Repository/ORMの奥で副作用が起きる

### 副作用の分類

```yaml
side_effects:
  db:
    - type: write
      tables: [users, audit_logs]
    - type: read
      tables: [users]

  external:
    - type: http
      target: payment-gateway
    - type: email
      target: notification-service

  async:
    - type: event
      topic: user.created
    - type: queue
      queue: email-queue

  cache:
    - type: invalidate
      key: user:{id}
```

## 層C: 業務意味spec

### 定義

システムの「意図・理由・背景」を記述。ビジネスコンテキスト。

### 抽出対象

| 項目 | 例 | 根拠の強さ |
|------|-----|----------|
| 目的 | `ユーザー認証を提供` | 弱（コードに書かれない） |
| 理由 | `法規制対応のため` | 弱（コードに書かれない） |
| トレードオフ | `速度よりセキュリティ優先` | 弱（コードに書かれない） |
| SLA | `99.9%可用性` | 弱（運用ドキュメント依存） |
| 性能目標 | `p99 < 100ms` | 弱（測定が必要） |

### 生成精度

**低精度・草案のみ**

理由:
- 「なぜそうするか」がコードに書かれていない
- AIが穴を埋めると「整った嘘」になる
- 人間による検証・補完が必須

### 草案として扱うルール

1. すべての断定に`[Assumed]`または`[Unknown]`を付ける
2. 「レビュー依頼」を明記する
3. 確定させる場合はADR（Architecture Decision Record）で決裁

## 層間の関係

```
層C（業務意味）→ 「なぜ」を規定
     ↓
層B（振る舞い）→ 「どう動くか」を規定
     ↓
層A（インターフェース）→ 「何が見えるか」を規定
     ↓
実装コード → 「どう作るか」
```

上位層が変わると下位層に影響。
下位層から上位層は推測のみ（断定不可）。

## 層ごとの確度期待値

| 層 | Verified期待 | Observed期待 | Assumed/Unknown許容 |
|----|-------------|--------------|-------------------|
| A | 高（型・テスト） | 中 | 低 |
| B | 中 | 高 | 中 |
| C | 低 | 低 | 高 |

層Cで`Verified`が多いのは危険信号（過信の可能性）。
