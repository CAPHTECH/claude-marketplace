# Pass 2: 横断統合（Integration）

## 目的

Pass 1の事実を統合し、以下を生成:
1. Codebase Map（コード地図）
2. 代表フロー（Representative Flows）
3. Change Playbook（変更ガイド）
4. 不変条件（Invariants）

## 1. Codebase Map

### 目的

新規参加者が**最初の変更を成立させる**ために必要な全体像

### 含めるべき要素

| 要素 | 説明 |
|------|------|
| モジュール責務 | 各ディレクトリ/パッケージの役割 |
| 依存関係 | モジュール間の参照関係 |
| エントリポイント | 外部からの入口 |
| 主要データ | 中心的なエンティティ/テーブル |
| 外部境界 | 外部システムとの接点 |

### 粒度の指針

```
❌ 悪い例: 詳細と概略が混在
  auth/ - JWTトークンを発行する。HS256を使用。
  api/ - HTTPリクエストを処理。

✅ 良い例: 粒度を揃える
  auth/ - 認証・認可の責務。セッション管理を含む。
  api/ - HTTPハンドラ。ルーティングとリクエスト変換。
```

### テンプレート

```markdown
# Codebase Map

## システム概要
[1-2文で目的を説明]

## モジュール構成

| モジュール | 責務 | 主要依存 | 備考 |
|-----------|------|---------|------|
| src/api/ | HTTPハンドラ | services | ルーティング定義 |
| src/services/ | ビジネスロジック | repositories | トランザクション境界 |
| src/repositories/ | データアクセス | db | SQL発行 |

## エントリポイント

| 種類 | 場所 | 起動方法 |
|------|------|---------|
| HTTP | src/api/server.ts | `npm run start` |
| CLI | src/cli/main.ts | `npm run cli` |
| Worker | src/worker/index.ts | `npm run worker` |

## 主要データ

| エンティティ | テーブル | 責務 |
|-------------|---------|------|
| User | users | ユーザー情報 |
| Session | sessions | ログインセッション |

## 外部境界

| 外部システム | 用途 | 設定キー | 障害時の挙動 |
|-------------|------|---------|-------------|
| PostgreSQL | 永続化 | DATABASE_URL | 503エラー |
| Redis | セッション | REDIS_URL | DBにフォールバック |
| SendGrid | メール送信 | SENDGRID_KEY | キューイング |
```

## 2. 代表フロー

### 選定基準

**利用頻度ではなく、以下で選ぶ:**

| 評価軸 | 重み | 説明 |
|--------|------|------|
| 変更頻度 | 高 | 開発者が頻繁に触る |
| 境界条件カバー | 高 | 認証/DB/非同期/外部連携/削除 |
| 不変条件 | 高 | 冪等性/整合性/権限/監査 |
| 被害規模 | 中 | 障害時のビジネスインパクト |
| 追跡可能性 | 中 | デバッグの容易さ |

### 本数の目安

2-5本で以下をカバー:

- [ ] 認証が絡むフロー
- [ ] DB書込みがあるフロー
- [ ] 非同期処理（イベント/ジョブ）
- [ ] 外部API連携
- [ ] 削除/退会など破壊的操作

### 構成

各フローは **成功 + 代表失敗2件** をセットで記述

### テンプレート

```markdown
# フロー: [フロー名]

## 概要
[1文で何をするフローか]

## 成功シナリオ

### ステップ
1. [入口] → [処理1] (ファイル:行)
2. [処理1] → [処理2] (ファイル:行)
3. [処理2] → [出口]

### 副作用
- DB: INSERT INTO users (UserRepository:45)
- Event: user.created (EventPublisher:78)

### 検証ポイント
- [ ] 戻り値が期待通りか
- [ ] DBレコードが作成されているか
- [ ] イベントが発行されているか

## 失敗シナリオ1: [失敗パターン名]

### 条件
[どのような状況で発生するか]

### 発生箇所
[ファイル:行]

### 処理
1. [例外発生]
2. [ロールバック/リトライ等]
3. [エラーレスポンス]

### 副作用
- DB: ロールバック
- Log: ERROR レベルで記録

## 失敗シナリオ2: [失敗パターン名]
...

## 不変条件

| 条件 | 検証方法 | 違反時 |
|------|---------|--------|
| メール一意性 | UNIQUE制約 | 409 Conflict |
| パスワードハッシュ化 | 保存前バリデーション | 500 Error |

## 関連テスト
- tests/integration/user_registration.test.ts
- tests/e2e/signup.spec.ts
```

## 3. Change Playbook

### 目的

「Xを変えるときにYを確認する」を具体的に示す

### テンプレート

```markdown
# 変更ガイド: [変更対象]

## 影響範囲マップ

```
[変更対象]
  ├── 直接依存: [モジュールA], [モジュールB]
  └── 間接依存: [モジュールC]
```

## 変更パターン別チェック

### パターン1: [変更の種類]

**想定される変更**
- フィールド追加
- バリデーション変更
- etc.

**確認事項**
- [ ] [具体的なチェック項目]
- [ ] [具体的なチェック項目]

**必須テスト**
- tests/xxx.test.ts

### パターン2: [変更の種類]
...

## 破壊的変更の境界

| 変更 | 影響 | 対策 |
|------|------|------|
| API レスポンス構造変更 | 全クライアント | バージョニング |
| DBスキーマ変更 | マイグレーション必須 | ダウンタイム考慮 |

## レビュー観点

- [ ] 後方互換性は維持されているか
- [ ] 既存テストは通るか
- [ ] ドキュメント更新は必要か
```

## 4. 不変条件

### 抽出対象

| 種類 | 例 |
|------|-----|
| 冪等性 | 同じリクエストで同じ結果 |
| 整合性 | 親子レコードの参照整合 |
| 権限 | リソースオーナーのみ操作可 |
| 監査 | 操作ログの記録 |
| 状態遷移 | 許可された遷移のみ |
| タイムアウト | 処理時間の上限 |

### テンプレート

```markdown
# 不変条件一覧

## システム全体

| 条件 | 根拠 | 検証方法 |
|------|------|---------|
| 全API認証必須 | (middleware/auth.ts:15) | 認証ミドルウェア |
| リクエストログ | (middleware/logging.ts:8) | ログ出力確認 |

## ドメイン別

### User
| 条件 | 根拠 | 検証方法 |
|------|------|---------|
| メール一意 | (models/user.ts:23) | UNIQUE制約 |
| パスワード平文禁止 | (services/user.ts:56) | ハッシュ関数適用 |

### Order
| 条件 | 根拠 | 検証方法 |
|------|------|---------|
| 注文確定後は編集不可 | (services/order.ts:89) | 状態チェック |
```

## チェックリスト

```markdown
### Codebase Map
- [ ] 新規参加者が入口を見つけられるか
- [ ] 粒度が揃っているか
- [ ] 外部境界が明示されているか

### 代表フロー
- [ ] 境界条件をカバーしているか
- [ ] 成功+失敗2件がセットか
- [ ] 根拠参照が付いているか

### Change Playbook
- [ ] 具体的なチェック項目があるか
- [ ] 破壊的変更の境界が明示されているか
- [ ] 必須テストが列挙されているか

### 不変条件
- [ ] 暗黙知が明文化されているか
- [ ] 検証方法が示されているか
```
