# Feedback Loop: フィードバックを制約として蓄積

## 目的

指摘・修正を**次回の出力制約**に変換し、同じ誤りの再発を防ぐ。

## フィードバック分類

### 3カテゴリ

| カテゴリ | 説明 | 戻す先 |
|----------|------|--------|
| 事実誤認 | 記述内容が間違っている | Pass 1 |
| カバレッジ不足 | 必要な情報が欠けている | Pass 2 |
| 読みにくさ | 構造・粒度・表現の問題 | Pass 2/3 |

### 分類例

```markdown
## フィードバック例

### 事実誤認
「UserServiceはEmailServiceに依存」と記載したが、
実際はNotificationServiceを経由している。
→ Pass 1 の依存関係を修正

### カバレッジ不足
「削除フローが代表フローにない」
削除は破壊的操作で境界条件として重要。
→ Pass 2 で削除フローを追加

### 読みにくさ
「Codebase Mapの粒度がバラバラ」
詳細なモジュールと概略が混在している。
→ Pass 2/3 で粒度を揃える
```

## 制約への変換

### 変換パターン

| フィードバック | 制約 |
|---------------|------|
| 「この断定は根拠がなかった」 | 「この種の断定は根拠必須」 |
| 「この境界条件が抜けていた」 | 「この境界条件は必ず記述」 |
| 「このモジュールが索引になかった」 | 「このモジュールは索引に含める」 |
| 「この外部連携が不明だった」 | 「外部連携は障害時挙動まで記載」 |

### 制約フォーマット

```markdown
# 出力制約

## Pass 1 制約

### 根拠必須項目
- キャッシュの導入理由
- リトライ回数の根拠
- タイムアウト値の根拠

### 必須抽出対象
- [モジュールA] は必ず Fact Index に含める
- [設定キーX] は必ず設定一覧に含める

## Pass 2 制約

### 必須カバー境界条件
- 削除/退会フロー
- 外部API障害時のフォールバック
- 同時実行時の排他制御

### 粒度規則
- Codebase Map はディレクトリ単位で統一
- 代表フローは「入口→処理→出口」の3層で記述

## Pass 3 制約

### 強化検証項目
- 外部境界の障害時挙動は必ず記載確認
- Redis関連は起動方法を必ず確認
```

## 制約の適用

### 適用タイミング

```
新規ドキュメント生成開始
    ↓
蓄積された制約を読み込み
    ↓
Pass 1: 制約に基づいて抽出
    ↓
Pass 2: 制約に基づいて統合
    ↓
Pass 3: 制約に基づいて検証
```

### 適用チェック

```markdown
## 制約適用チェックリスト

### Pass 1
- [ ] 根拠必須項目に根拠を付けたか
- [ ] 必須抽出対象を含めたか

### Pass 2
- [ ] 必須カバー境界条件を含めたか
- [ ] 粒度規則に従っているか

### Pass 3
- [ ] 強化検証項目を確認したか
```

## 制約の管理

### 保存場所

```
.doc-gen/
├── constraints.md     # 出力制約
├── feedback-log.md    # フィードバック履歴
└── verification-log.md # 検証結果履歴
```

### 制約のライフサイクル

```
フィードバック受領
    ↓
分類（事実誤認/カバレッジ/読みにくさ）
    ↓
制約として言語化
    ↓
constraints.md に追記
    ↓
次回生成時に適用
    ↓
[定期] 制約の棚卸し
    ↓
陳腐化した制約を削除
```

### 棚卸し基準

| 状況 | 対応 |
|------|------|
| 3回連続で適用後問題なし | 制約を維持 |
| コードベースの構造変更 | 制約を更新 |
| 制約が形骸化 | 制約を削除 |

## フィードバック収集テンプレート

```markdown
# フィードバックフォーム

## 対象ドキュメント
- ファイル: [path]
- セクション: [section]

## フィードバック種類
- [ ] 事実誤認
- [ ] カバレッジ不足
- [ ] 読みにくさ
- [ ] その他

## 詳細
[具体的な問題点]

## 期待する状態
[どうなっていれば良かったか]

## 提案する制約
[次回以降どうすべきか]
```

## チェックリスト

```markdown
### フィードバック処理
- [ ] フィードバックを分類したか
- [ ] 制約として言語化したか
- [ ] constraints.md に記録したか

### 制約適用
- [ ] 生成前に制約を読み込んだか
- [ ] 各Passで制約を適用したか
- [ ] 適用チェックを実施したか

### 制約管理
- [ ] 定期的に棚卸ししているか
- [ ] 陳腐化した制約を削除したか
```
