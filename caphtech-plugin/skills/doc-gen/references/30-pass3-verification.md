# Pass 3: 検証（Verification）

## 目的

ドキュメントの**信頼性を獲得**する。
生成AIの「整っている嘘」を防ぎ、参照され続けるドキュメントにする。

## 3つの検証ゲート

### 1. Evidence Gate（根拠ゲート）

**目的**: 根拠のない断定を減らす

#### プロセス

```
重要な断定文を抽出
    ↓
根拠参照（ファイル:行）があるか？
    ↓
YES → 維持
NO  → 表現を弱める or 「未確認」として隔離
```

#### 表現の弱め方

```markdown
❌ 断定（根拠なし）
このキャッシュは性能最適化のために導入された。

✅ 弱めた表現
このキャッシュが存在する。(src/cache/user.ts:45)
導入理由は確認できていない。

✅ 隔離
## 未確認事項
- キャッシュ導入の意図（ADR未発見）
```

#### チェック対象

| 断定種類 | 根拠必須度 |
|----------|-----------|
| 技術的事実（シグネチャ等） | 必須 |
| 副作用の存在 | 必須 |
| 意図・理由 | 根拠があれば記載、なければ「不明」 |
| 性能特性 | 「測定が必要」と明記 |
| 将来の変更予定 | 根拠（Issue/ADR）がなければ削除 |

### 2. Consistency Gate（矛盾ゲート）

**目的**: Pass 1（事実）とPass 2（説明）の整合性を保証

#### チェック項目

| Pass 1 | Pass 2 | チェック |
|--------|--------|---------|
| シンボル一覧 | 代表フローの参照 | フローで参照されるシンボルがPass 1に存在するか |
| 副作用リスト | フローの副作用記述 | 一致しているか |
| 依存関係 | Codebase Map | 矛盾がないか |
| 設定キー | 外部境界 | 網羅されているか |

#### 矛盾発見時の対応

```markdown
## 矛盾検出レポート

### 矛盾1
- **Pass 1**: UserService は EmailService に依存 (fact-index:23)
- **Pass 2**: 代表フローに EmailService の記述なし
- **対応**: フローに EmailService の呼び出しを追加

### 矛盾2
- **Pass 1**: キャッシュ更新の副作用あり (fact-index:45)
- **Pass 2**: 副作用セクションにキャッシュ記載なし
- **対応**: 副作用セクションにキャッシュ更新を追加
```

### 3. Task-based Verification（タスクベース検証）

**目的**: 開発者が実際にやる行為で検証し、実務で役立つことを保証

#### 検証タスク

| タスク | 検証内容 |
|--------|---------|
| ローカルで動かす | 手順が実行可能か、前提条件が明記されているか |
| 変更する | 影響範囲の情報が揃っているか |
| 影響範囲を見る | 依存関係が追えるか |
| デバッグする | ログ/トレースの場所が分かるか |
| テストを追加する | 関連テストの場所が分かるか |

#### 検証テンプレート

```markdown
## タスクベース検証

### タスク1: 新規参加者がローカルで動かす

**前提条件**
- [ ] 必要な環境変数が明記されているか
- [ ] 依存サービスの起動方法が分かるか
- [ ] 最初のAPIコールまでの手順が明確か

**検証結果**
- ✅ DATABASE_URL の説明あり
- ❌ Redis の起動方法が不明 → 追記必要

### タスク2: UserService に機能追加

**確認事項**
- [ ] 影響を受けるモジュールが分かるか
- [ ] 追加すべきテストの場所が分かるか
- [ ] 必要なレビュー観点が分かるか

**検証結果**
- ✅ Change Playbook に依存関係記載
- ❌ テストファイルの場所が不明確 → 追記必要

### タスク3: 本番エラーをデバッグ

**確認事項**
- [ ] ログ出力箇所が分かるか
- [ ] トレースIDの伝播経路が分かるか
- [ ] 関連する外部システムが分かるか

**検証結果**
- ✅ 外部境界に障害時挙動記載
- ❌ ログフォーマットの説明なし → 追記検討
```

## 検証レポートフォーマット

```markdown
# 検証レポート

## サマリー

| ゲート | 結果 | 対応項目数 |
|--------|------|-----------|
| Evidence Gate | ⚠️ | 3件の弱め処理 |
| Consistency Gate | ✅ | 0件の矛盾 |
| Task-based | ⚠️ | 2件の追記必要 |

## Evidence Gate

### 弱めた断定

1. **キャッシュの導入理由**
   - 元: 「性能最適化のために導入」
   - 後: 「キャッシュが存在（導入理由は未確認）」

2. **リトライ回数の根拠**
   - 元: 「最適なリトライ回数として3回」
   - 後: 「リトライ回数は3回（src/config.ts:45）」

### 隔離した事項

- キャッシュTTL設計の意図
- APIレート制限値の根拠

## Consistency Gate

### 検出した矛盾

なし

## Task-based Verification

### 要追記事項

1. **Redis起動方法**
   - 対象: Codebase Map > 外部境界
   - 追記内容: `docker-compose up redis`

2. **テストファイル配置規則**
   - 対象: Change Playbook
   - 追記内容: `tests/` 配下の構成説明

## 次のアクション

- [ ] 隔離した事項について開発者に確認
- [ ] 要追記事項をドキュメントに反映
- [ ] フィードバックループで制約として記録
```

## チェックリスト

```markdown
### Evidence Gate
- [ ] 重要な断定文を抽出したか
- [ ] 根拠のない断定を弱めたか
- [ ] 未確認事項を隔離したか

### Consistency Gate
- [ ] Pass 1/2間の整合性をチェックしたか
- [ ] 矛盾を解消または報告したか

### Task-based Verification
- [ ] ローカル起動タスクで検証したか
- [ ] 変更タスクで検証したか
- [ ] デバッグタスクで検証したか
- [ ] 不足情報を特定したか
```
