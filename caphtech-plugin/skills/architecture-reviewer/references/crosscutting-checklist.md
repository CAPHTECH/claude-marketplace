# クロスカッティング分析チェックリスト

システム横断的な品質を検証するための詳細チェックリスト。

## 目次

- [Security（セキュリティ）](#security)
- [Reliability（信頼性）](#reliability)
- [Observability（観測性）](#observability)
- [Changeability（変更容易性）](#changeability)

---

## Security

### 脅威モデルとの整合

| チェック項目 | 確認内容 |
|-------------|---------|
| 認証境界の一貫性 | 全エントリーポイントで認証が必須か |
| 認可の責任所在 | 各コンポーネントで認可チェックが実装されているか |
| 信頼境界の明確化 | 内部通信でも最小限の検証があるか |
| シークレット管理 | ハードコードされた秘密情報がないか |

### 具体的なチェック

```yaml
security_checklist:
  authentication:
    - すべての公開エンドポイントに認証があるか
    - 内部APIにも認証/認可があるか（ゼロトラスト）
    - トークンの有効期限は適切か
    - リフレッシュトークンの管理は安全か

  authorization:
    - リソースの所有権チェックがあるか
    - ロールベースアクセス制御（RBAC）が一貫しているか
    - 権限昇格の経路がないか
    - 管理者権限の分離ができているか

  data_protection:
    - 機密データは暗号化されているか（at-rest, in-transit）
    - PII/PHIの取り扱いが適切か
    - ログに機密情報が含まれていないか
    - バックアップの暗号化は有効か

  input_validation:
    - すべての入力がバリデーションされているか
    - SQLインジェクション対策があるか
    - XSS対策があるか
    - パストラバーサル対策があるか
```

### 典型的な問題パターン

| パターン | 症状 | 対策 |
|---------|------|------|
| 認可バイパス | 内部APIに認可がない | 各サービスで所有権チェック |
| 境界超え | 認証後に内部で信頼しすぎ | ゼロトラストの導入 |
| 秘密漏洩 | ログに機密情報 | 構造化ログ + 自動マスキング |

---

## Reliability

### SLO/SLI の整合

| チェック項目 | 確認内容 |
|-------------|---------|
| SLO定義の有無 | 各コンポーネントにSLOが定義されているか |
| SLI測定可能性 | SLOを測定するためのメトリクスがあるか |
| 連鎖障害の考慮 | 依存先のSLOが自身のSLOを上回っていないか |
| エラーバジェット | エラーバジェットの消費を追跡しているか |

### 具体的なチェック

```yaml
reliability_checklist:
  availability:
    - 各コンポーネントの可用性目標は明確か
    - 依存先の可用性を考慮しているか
    - 複合可用性（A × B × C）が目標を満たすか
    - 単一障害点（SPOF）がないか

  fault_isolation:
    - 障害が他コンポーネントに波及しないか
    - サーキットブレーカーが実装されているか
    - タイムアウトが適切に設定されているか
    - バルクヘッドパターンが適用されているか

  recovery:
    - 自動リカバリ機能があるか
    - 手動介入が必要な場合の手順があるか
    - バックアップからの復旧が可能か
    - RTO/RPOが定義されているか

  graceful_degradation:
    - 部分障害時にコア機能は維持されるか
    - フォールバック戦略があるか
    - ユーザーへの影響が最小化されるか
```

### 可用性の計算例

```
order-service (99.9%) → payment-service (99.9%) → bank-api (99.5%)

複合可用性 = 0.999 × 0.999 × 0.995 = 99.3%

目標が99.9%なら、キャッシュやフォールバックが必要
```

---

## Observability

### 責務境界との一致

| チェック項目 | 確認内容 |
|-------------|---------|
| ログの境界 | 各コンポーネントのログが責務と一致しているか |
| メトリクスの粒度 | コンポーネント単位で測定可能か |
| トレースの連続性 | リクエストを端から端まで追跡可能か |
| アラートの責任 | 誰が対応するか明確か |

### 具体的なチェック

```yaml
observability_checklist:
  logging:
    - 構造化ログを使用しているか
    - correlation_idが伝播されているか
    - ログレベルが適切か
    - 機密情報がマスクされているか
    - 保持期間が定義されているか

  metrics:
    - RED（Rate, Errors, Duration）が測定されているか
    - カスタムビジネスメトリクスがあるか
    - メトリクスの粒度は適切か
    - 異常検知が設定されているか

  tracing:
    - 分散トレーシングが有効か
    - スパンが適切に定義されているか
    - サンプリングレートは適切か
    - 外部サービス呼び出しも追跡されているか

  alerting:
    - SLO違反のアラートがあるか
    - アラートの優先度が定義されているか
    - オンコールローテーションがあるか
    - エスカレーションパスが明確か
```

### 観測性のギャップ検出

```yaml
# コンポーネントカードとの照合
gap_detection:
  - component: order-service
    dossier_says: "DataDog metrics"
    actual_check: metricsエンドポイントがない
    gap: メトリクス収集が未実装

  - component: payment-service
    dossier_says: "structured JSON logging"
    actual_check: 一部プレーンテキストログ
    gap: ログフォーマットが不統一
```

---

## Changeability

### モジュール結合度

| チェック項目 | 確認内容 |
|-------------|---------|
| 結合度の種類 | データ結合 < スタンプ結合 < 制御結合 < 内容結合 |
| 変更波及範囲 | 1箇所の変更が何コンポーネントに影響するか |
| インターフェース安定性 | 公開APIの変更頻度 |
| 循環依存 | A→B→C→A のサイクルがないか |

### 具体的なチェック

```yaml
changeability_checklist:
  coupling:
    - コンポーネント間の結合度は適切か
    - 共有データベースがないか（または適切に分離されているか）
    - 共有ライブラリの変更影響は限定的か
    - イベント駆動で疎結合になっているか

  interface_stability:
    - 公開APIにバージョニングがあるか
    - 破壊的変更の管理プロセスがあるか
    - 非推奨（deprecation）ポリシーがあるか
    - 後方互換性が維持されているか

  impact_analysis:
    - 変更影響の分析方法があるか
    - 依存グラフが可視化されているか
    - 変更時のテスト範囲が明確か
    - 段階的ロールアウトが可能か

  documentation:
    - ADR（アーキテクチャ決定記録）があるか
    - ADRと実装が一致しているか
    - 設計意図が文書化されているか
    - オンボーディング資料があるか
```

### ADR整合チェック

```yaml
adr_consistency:
  - adr: ADR-001-use-event-sourcing
    status: accepted
    implementation_check:
      - order-service: 準拠（イベントストア使用）
      - inventory-service: 違反（直接DB更新）
    finding: inventory-serviceがADRに違反

  - adr: ADR-005-api-versioning
    status: accepted
    implementation_check:
      - すべてのAPI: /v1/ プレフィックスあり
    finding: なし（準拠）
```

---

## 優先度の判定

クロスカッティング指摘の優先度は以下で判定:

| 要素 | 重み | 説明 |
|------|------|------|
| Severity | 高 | 発生時の影響度（critical/high/medium/low） |
| Likelihood | 中 | 発生確率（high/medium/low） |
| Detectability | 中 | 検出の難易度（hard/medium/easy） |

```
Priority = Severity × Likelihood × (1 / Detectability)
```

| Priority Score | 対応 |
|----------------|------|
| 9+ | 即時対応（リリースブロック） |
| 6-8 | 次スプリントで対応 |
| 3-5 | バックログに追加 |
| 1-2 | 技術的負債として記録 |
