# 完成前検証詳細チェックリスト

PR作成前の完成前検証のための詳細チェックリスト。各項目を確認し、すべてにチェックが入ることを確認する。

## Phase 1: Evidence Pack完全性

### 1.1 因果マップ

- [ ] **変更の因果関係**が明確に記述されている
  - 変更の意図が明記されている
  - 変更がどのLaw/Termに関連するか明確
  - 変更の理由（Why）が記述されている

- [ ] **影響範囲グラフ**が存在する
  - 変更ファイル一覧がリストされている
  - 依存関係グラフが正確
  - 波及範囲が予測されている

- [ ] **データフロー**が追跡可能
  - データの流れが図示されている
  - 入力→処理→出力が明確
  - データ変換の各ステップが記述されている

### 1.2 証拠

- [ ] **各Law/TermにEvidence Levelが設定**されている
  - S0 LawにはL1/L2/L4が設定されている
  - S1 LawにはL1が設定されている
  - S2 LawにはオプションでL1/L4が設定されている

- [ ] **Evidence Ladderの目標レベルを達成**している
  - L1: ユニットテストが100%パス
  - L2: 統合テストが100%パス
  - L4: Telemetry設定が完了している

- [ ] **テスト結果が添付**されている
  - テスト実行ログが evidence-pack/evidence/test-results.txt に存在
  - テストカバレッジレポートが存在
  - すべてのテストがパスしている

### 1.3 影響範囲グラフ

- [ ] **変更ファイルがすべてリストされている**
  - evidence-pack/impact-graph.yaml に changed_files フィールドが存在
  - すべての変更ファイルが列挙されている
  - 新規ファイル・削除ファイルも含まれている

- [ ] **依存関係グラフが正確**
  - dependencies フィールドが存在
  - モジュール間の依存関係が正しい
  - 循環依存が検出されている場合は警告されている

- [ ] **波及範囲が予測されている**
  - ripple_effect フィールドが存在
  - Low/Medium/High/Critical のいずれかが設定されている
  - 予測根拠が記述されている

### 1.4 Law/Term整合性

- [ ] **すべてのLaw Cardが存在**する
  - law-catalog/ ディレクトリに全Law Cardがある
  - 各Law CardがYAMLフォーマットで記述されている
  - 必須フィールド（id/scope/statement/enforcement）が存在

- [ ] **すべてのTerm Cardが存在**する
  - term-catalog/ ディレクトリに全Term Cardがある
  - 各Term CardがYAMLフォーマットで記述されている
  - 必須フィールド（id/category/definition/observation）が存在

- [ ] **Link Mapに孤立がない**
  - link-map.yaml が存在
  - すべてのLaw Cardがlink-mapに登場する
  - すべてのTerm Cardがlink-mapに登場する
  - 孤立したLaw/Termがない

- [ ] **Grounding Mapが完成している**
  - grounding-map.yaml が存在
  - すべてのLawにEvidence Levelが設定されている
  - 観測写像（verification/observation）が記述されている

---

## Phase 2: Law/Term孤立チェック

### 2.1 Law孤立の検出

- [ ] **Law Catalog一覧とLink Mapを比較**
  - law-catalog/*.yaml の全ファイルを抽出
  - link-map.yaml の全Law IDを抽出
  - 差分を確認（差分がある場合は孤立）

- [ ] **孤立Lawが存在しない**
  - 孤立Lawが0件である
  - または、孤立Lawに対する対応計画が存在する

### 2.2 Term孤立の検出

- [ ] **Term Catalog一覧とLink Mapを比較**
  - term-catalog/*.yaml の全ファイルを抽出
  - link-map.yaml の全Term IDを抽出
  - 差分を確認（差分がある場合は孤立）

- [ ] **孤立Termが存在しない**
  - 孤立Termが0件である
  - または、孤立Termに対する対応計画が存在する

### 2.3 循環参照の検出

- [ ] **Link Mapの循環参照を確認**
  - Law ↔ Term の参照関係をグラフ化
  - 循環が存在しないか確認
  - 循環がある場合は整理計画が存在する

---

## Phase 3: Evidence Ladder達成確認

### 3.1 S0 Laws

- [ ] **すべてのS0 LawがL1を達成**
  - ユニットテストが100%パス
  - カバレッジが100%
  - すべての分岐/境界条件がテストされている

- [ ] **すべてのS0 LawがL2を達成**
  - 統合テストシナリオが実装されている
  - テストが100%パス
  - 境界越えの因果が検証されている

- [ ] **すべてのS0 LawがL4を達成**
  - Telemetry設定が完了している
  - メトリクス定義が存在する
  - アラート設定が存在する

### 3.2 S1 Laws

- [ ] **すべてのS1 LawがL1を達成**
  - ユニットテストが80%以上パス
  - 主要パターンがテストされている
  - テスト結果が記録されている

### 3.3 S2 Laws

- [ ] **S2 Lawsのオプション要件を確認**
  - L1推奨: 可能であればユニットテスト実装
  - L4推奨: 可能であればTelemetry設定

### 3.4 Evidence不足の検出

- [ ] **不足Evidenceを自動検出**
  - grounding-map.yaml から要件と実際を比較
  - 不足Evidenceをリストアップ
  - 不足Evidenceの補完計画が存在する

---

## Phase 4: 停止条件確認

### 4.1 予測と現実の乖離

- [ ] **テスト失敗回数をカウント**
  - .test-failure-count ファイルが存在する
  - 失敗回数が3回未満である
  - 3回以上の場合は原因分析が完了している

### 4.2 観測不能な変更

- [ ] **すべての変更に対応するテストが存在**
  - evidence-pack/changed-files.txt を確認
  - 各変更ファイルに対応するテストファイルが存在
  - テストがない変更は0件である

### 4.3 ロールバック線の崩壊

- [ ] **不可逆的な変更が存在しない**
  - evidence-pack/irreversible-changes.txt が空である
  - または、不可逆的変更に対する補償メカニズムが存在する
  - データベースマイグレーションがロールバック可能

### 4.4 Issue Contract違反

- [ ] **物差しがすべて満たされている**
  - issue-contract.yaml の acceptance_criteria を確認
  - すべての物差しにチェックが入っている
  - 未達成の物差しがない

---

## Phase 5: ロールバック可能性

### 5.1 コード変更のロールバック

- [ ] **すべてのコード変更がgit revertで戻せる**
  - コミット履歴が適切に分割されている
  - 各コミットが独立してrevert可能
  - コミットメッセージが明確

### 5.2 データ変更のロールバック

- [ ] **データベースマイグレーションがロールバック可能**
  - downマイグレーションスクリプトが存在
  - downマイグレーションがテスト済み
  - データ損失のリスクが評価されている

### 5.3 設定変更のロールバック

- [ ] **設定変更がロールバック可能**
  - 旧設定のバックアップが存在
  - 設定変更の影響範囲が明確
  - ロールバック手順が文書化されている

### 5.4 外部サービス変更のロールバック

- [ ] **外部サービス変更がロールバック可能**
  - APIバージョニングで後方互換性を保証
  - Feature Flagで段階的ロールアウト
  - 失敗時の切り戻し手順が文書化されている

---

## Phase 6: PR品質

### 6.1 PR本文

- [ ] **PR本文がEvidence Pack形式で記述されている**
  - 因果マップが含まれている
  - 証拠が含まれている
  - 影響範囲グラフが含まれている
  - Law/Term整合性が記述されている

### 6.2 コミット履歴

- [ ] **コミット履歴が明確**
  - 各コミットが原子的（5-10分単位）
  - コミットメッセージが明確
  - Co-Authored-By: Claude が含まれている

### 6.3 レビュー準備

- [ ] **レビューに必要な情報がすべて揃っている**
  - テスト結果が添付されている
  - 影響範囲が明確
  - ロールバック手順が文書化されている

---

## 完了判定

### すべてのチェック項目が完了している場合

```
✓ PR READY

すべての完了条件が満たされています。
PRを作成してください。
```

### 1つでも未完了の項目がある場合

```
✗ PR NOT READY

以下の項目が未完了です:

Phase 1:
  - [ ] テスト結果が添付されていない

Phase 2:
  - [ ] Law孤立が2件存在する

...

これらの項目を完了させてから再度チェックしてください。
```

---

## チェックリスト実行方法

### 手動チェック

このチェックリストを印刷またはコピーし、各項目を順番に確認する。

### 自動チェック

```bash
bash scripts/pre-completion-check.sh
```

### CI/CD統合

GitHub Actionsで自動実行（詳細は ci-integration.md 参照）。

---

## トラブルシューティング

### Evidence不足が検出された場合

**症状**: S0 LawのL4が未達成

**対策**:
```yaml
1. Telemetry設定を追加
   - src/observability/metrics.ts にメトリクス定義
   - アラート設定を追加

2. Grounding Mapを更新
   - L4 Evidenceを追加

3. 再検証
   - bash scripts/pre-completion-check.sh
```

### Law/Term孤立が検出された場合

**症状**: 孤立Lawが3件存在

**対策**:
```yaml
1. 孤立Lawを確認
   - law-catalog/LAW-xxx.yaml を確認
   - 本当に必要なLawか判断

2. Link Mapに追加
   - link-map.yaml に Law ↔ Term の参照を追加

3. または削除
   - 不要なLaw Cardを削除

4. 再検証
   - bash scripts/pre-completion-check.sh
```

### テスト失敗回数超過の場合

**症状**: テスト失敗回数が3回以上

**対策**:
```yaml
1. 失敗原因を分析
   - なぜ予測と現実が乖離したか調査
   - Issue Contractの前提条件を見直し

2. スコープ縮小または追加計測
   - スコープを縮小して影響範囲を限定
   - または追加のテスト/観測を実施

3. カウンタリセット
   - echo 0 > .test-failure-count

4. 再検証
   - bash scripts/pre-completion-check.sh
```

---

## まとめ

### チェックリストの核心原則

1. **完了の定義の厳格性**: すべての項目にチェックが必要
2. **Evidence First**: 証拠なき主張は不完全
3. **孤立の排除**: Law/Termは必ずLink Mapに存在
4. **観測可能性**: すべてのLawに観測写像が存在
5. **ロールバック可能性**: 失敗時に元に戻せる

### チェック項目数

- Phase 1: 12項目
- Phase 2: 6項目
- Phase 3: 9項目
- Phase 4: 8項目
- Phase 5: 8項目
- Phase 6: 6項目

**合計**: 49項目

すべての項目にチェックが入った時点で、PR作成可能と判定。
