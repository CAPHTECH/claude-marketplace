# Predict（予測）フェーズ

影響を因果タイプ分類し、段階化戦略と停止条件を確定する。

## 目的

- 「賢く動く」よりも「壊さずに収束する」
- 変更の影響を事前に分類・評価
- 安全上限を持った自律編集の設計

## 因果タイプ分類

変更の影響を5つのタイプで分類:

| タイプ | 説明 | リスク | 対策 |
|--------|------|--------|------|
| **互換性** | API/スキーマの破壊 | High | 段階リリース、deprecation |
| **性能** | レスポンスタイム、スループット | Medium | ベンチマーク、負荷テスト |
| **信頼性** | 障害耐性、復旧時間 | High | フェイルセーフ、Circuit Breaker |
| **セキュリティ** | 認証/認可、データ保護 | Critical | セキュリティレビュー |
| **可観測性** | ログ、メトリクス、トレース | Low | 監視設定の確認 |

## 段階化戦略

### 危険度に応じた段階化

```
危険度: Low → Medium → High → Critical
段階数:  1      2-3      3-5     5+
```

### 段階化の原則

1. **最小単位で変更**: 1ステップ = 1概念の変更
2. **即時検証**: 各ステップ後に静的診断
3. **ロールバック可能**: 各ステップで戻せる状態を維持

### 段階化テンプレート

```markdown
## 段階化計画

### Step 1: 準備
- 変更内容: <具体的な変更>
- 検証方法: <静的診断/テスト>
- ロールバック: <戻し方>

### Step 2: 実装
...

### Step N: 統合
...
```

## 停止条件

### 標準停止条件

以下が発生したら追加計測またはスコープ縮小:

1. **予測と現実の継続的乖離**
   - 想定外のテスト失敗が3回以上
   - 想定外の依存関係が発見された

2. **観測不能な変更の増加**
   - 物差し（テスト/メトリクス）で検証できない変更が増える
   - 「動いているはず」という推測が増える

3. **ロールバック線の崩壊**
   - 戻せない変更が発生
   - 依存関係が複雑化して部分的な戻しが困難

### カスタム停止条件

Issue Contractで定義した追加の停止条件:

```markdown
## 停止条件（この Issue 固有）

- セキュリティ脆弱性が発見された場合
- 性能が20%以上劣化した場合
- 外部APIの仕様変更が判明した場合
```

## 反射の選択

変更後の診断結果に応じて、適切な反射を選択:

### 機械反射（自動対応）

- 型エラー → 型を修正
- lint警告 → フォーマット修正
- 未使用変数 → 削除

### 設計反射（判断が必要）

- テスト失敗 → 原因分析と修正方針決定
- 依存関係の問題 → アーキテクチャ検討
- 性能劣化 → 最適化戦略の検討

### 反射強度の制御

```
軽微な問題 → 機械反射で即修正
中程度の問題 → 設計反射で方針決定
重大な問題 → 停止条件発動、ユーザーに確認
```

## 影響予測テンプレート

```markdown
## 影響予測

### 直接影響（このファイルの変更）

| 変更点 | 因果タイプ | リスク | 対策 |
|--------|-----------|--------|------|
| <変更1> | 互換性 | High | 段階リリース |
| <変更2> | 性能 | Medium | ベンチマーク |

### 間接影響（依存先への伝播）

| 依存先 | 影響内容 | リスク | 確認方法 |
|--------|----------|--------|----------|
| <ファイル1> | <影響> | <リスク> | <テスト名> |

### 未確認の影響（unknown）

- DI経由での呼び出しは静的に追跡困難
- 設定ファイルからの参照は要確認

### 停止条件

- [ ] 想定外のテスト失敗が3回発生
- [ ] ロールバック不可能な状態になった
```

## 失敗パターン（必ず回避）

### 静的整合だけで完了扱い

**NG**: 「型エラーが消えたので完了」
**OK**: 「型エラー解消 + テスト通過 + 影響範囲確認」

### 表層エラーを消すための無理な対応

**NG**: 
- 無理なキャスト（`as any`）
- 例外の握り潰し（`catch {}`）
- 警告の無効化（`// @ts-ignore`）

**OK**: 根本原因の解決

### 参照がないから安全と判断

**NG**: 「grep で参照がないから安全」
**OK**: 以下も確認:
- DI/IoC経由の呼び出し
- 設定ファイルからの参照
- コード生成による参照
- リフレクションによる呼び出し

### 物差し不足なのに意味の正しさを断言

**NG**: 「テストはないけど正しく動くはず」
**OK**: 「テストがないため意味の正しさは検証未完了」

## チェックリスト

- [ ] 変更の影響を因果タイプで分類したか
- [ ] 危険度に応じた段階化計画を立てたか
- [ ] 停止条件を明確に定義したか
- [ ] 各ステップでロールバック可能か確認したか
- [ ] 静的に追跡困難な依存を「unknown」としてマークしたか
- [ ] 失敗パターンに該当していないか確認したか
