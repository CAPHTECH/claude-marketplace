# モデル化テンプレート

## 目次

1. [機能分解（Feature Tree）](#1-機能分解feature-tree)
2. [状態モデル（State Machine）](#2-状態モデルstate-machine)
3. [データモデル](#3-データモデル)
4. [外部IFモデル](#4-外部ifモデル)
5. [リスクモデル](#5-リスクモデル)

---

## 1. 機能分解（Feature Tree）

### 目的

システムの機能を階層的に分解し、テスト対象を網羅的に特定する。

### テンプレート

```markdown
# Feature Tree: [システム名]

## F1: [機能名1]
### F1.1: [サブ機能1-1]
- **操作**: [ユーザーが行う操作]
- **期待結果**: [観測可能な結果]
- **例外**: [エラー時の挙動]

### F1.2: [サブ機能1-2]
- **操作**: ...
- **期待結果**: ...
- **例外**: ...

## F2: [機能名2]
...
```

### 例：ECサイトの注文機能

```markdown
# Feature Tree: ECサイト注文システム

## F1: カート管理
### F1.1: 商品追加
- **操作**: 商品詳細から「カートに追加」をクリック
- **期待結果**: カートに商品が追加され、数量が表示される
- **例外**: 在庫切れの場合はエラー表示

### F1.2: 数量変更
- **操作**: カート画面で数量を変更
- **期待結果**: 数量と合計金額が更新される
- **例外**: 在庫超過時はエラー、0以下は削除確認

### F1.3: 商品削除
- **操作**: カート画面で削除ボタンをクリック
- **期待結果**: 商品が削除され、合計金額が更新される
- **例外**: なし

## F2: 注文処理
### F2.1: 配送先入力
- **操作**: 住所・連絡先を入力
- **期待結果**: 配送先が保存される
- **例外**: 必須項目未入力でエラー、配送不可地域でエラー

### F2.2: 決済
- **操作**: 決済方法選択、決済情報入力
- **期待結果**: 決済処理が完了し、注文確定
- **例外**: 決済エラー時は理由表示、リトライ可能
```

---

## 2. 状態モデル（State Machine）

### 目的

システムの状態遷移を明確化し、すべての遷移パスをテスト対象として特定する。

### テンプレート

```markdown
# State Model: [対象エンティティ]

## 状態一覧

| 状態ID | 状態名 | 説明 |
|--------|--------|------|
| S1 | [状態名] | [説明] |
| S2 | [状態名] | [説明] |
...

## 遷移一覧

| 遷移ID | From | To | トリガー | ガード条件 | アクション |
|--------|------|-----|---------|-----------|----------|
| T1 | S1 | S2 | [イベント] | [条件] | [実行内容] |
...

## 状態遷移図（Mermaid）

\`\`\`mermaid
stateDiagram-v2
    [*] --> S1
    S1 --> S2: トリガー [ガード]
    S2 --> S3: トリガー
    S3 --> [*]
\`\`\`
```

### 例：注文ステータス

```markdown
# State Model: 注文ステータス

## 状態一覧

| 状態ID | 状態名 | 説明 |
|--------|--------|------|
| S1 | 未確定 | カート状態 |
| S2 | 確定済 | 決済完了、発送待ち |
| S3 | 発送済 | 配送中 |
| S4 | 配達完了 | 受取済み |
| S5 | キャンセル | 取消済み |
| S6 | 返品 | 返品処理中 |

## 遷移一覧

| 遷移ID | From | To | トリガー | ガード条件 | アクション |
|--------|------|-----|---------|-----------|----------|
| T1 | S1 | S2 | 決済完了 | 在庫あり | 在庫引当、確認メール |
| T2 | S2 | S3 | 発送処理 | - | 追跡番号発行、発送メール |
| T3 | S3 | S4 | 配達完了 | - | ポイント付与 |
| T4 | S2 | S5 | キャンセル | 発送前 | 在庫戻し、返金 |
| T5 | S3 | S5 | キャンセル | 配達前 | 返送手配、返金 |
| T6 | S4 | S6 | 返品申請 | 14日以内 | 返品手続き開始 |

## 状態遷移図

\`\`\`mermaid
stateDiagram-v2
    [*] --> 未確定
    未確定 --> 確定済: 決済完了
    確定済 --> 発送済: 発送処理
    発送済 --> 配達完了: 配達完了
    確定済 --> キャンセル: キャンセル[発送前]
    発送済 --> キャンセル: キャンセル[配達前]
    配達完了 --> 返品: 返品申請[14日以内]
    キャンセル --> [*]
    返品 --> [*]
    配達完了 --> [*]
\`\`\`
```

---

## 3. データモデル

### 目的

データの構造、制約、整合性ルールを明確化し、データ観点のテスト条件を導出する。

### テンプレート

```markdown
# Data Model: [システム名]

## エンティティ一覧

### [エンティティ名]

| 属性 | 型 | 制約 | 説明 |
|-----|-----|------|------|
| id | UUID | PK, NOT NULL | 一意識別子 |
| name | VARCHAR(100) | NOT NULL | 名称 |
...

### 制約

- **一意性制約**: [説明]
- **参照整合性**: [説明]
- **ビジネスルール**: [説明]

### PII/秘匿データ

| 属性 | 分類 | 保護要件 |
|-----|------|---------|
| email | PII | 暗号化保存、ログ出力禁止 |
...
```

### 例：ユーザー管理

```markdown
# Data Model: ユーザー管理

## エンティティ一覧

### User

| 属性 | 型 | 制約 | 説明 |
|-----|-----|------|------|
| id | UUID | PK, NOT NULL | ユーザーID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ |
| name | VARCHAR(100) | NOT NULL | 表示名 |
| status | ENUM | NOT NULL, DEFAULT 'active' | active/suspended/deleted |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

### 制約

- **一意性制約**: email は全ユーザーで一意
- **参照整合性**: Order.user_id → User.id（CASCADE DELETE禁止）
- **ビジネスルール**:
  - パスワードは8文字以上、英数字記号混在
  - deleted ユーザーはログイン不可

### PII/秘匿データ

| 属性 | 分類 | 保護要件 |
|-----|------|---------|
| email | PII | ハッシュ化検索、ログ出力時マスク |
| password_hash | Secret | 暗号化保存、API非公開 |
| name | PII | 本人以外非表示オプション |

### 相関制約

- status='deleted' のとき email は '[deleted]_[id]@deleted' に変更
- 同一 email での再登録は 30日後から可能
```

---

## 4. 外部IFモデル

### 目的

外部システムとのインターフェースを明確化し、失敗パターンを網羅的にテスト条件化する。

### テンプレート

```markdown
# External IF Model: [システム名]

## IF一覧

### [IF名]

| 項目 | 内容 |
|-----|------|
| **種別** | REST API / gRPC / Webhook / ... |
| **エンドポイント** | [URL/パス] |
| **認証** | [認証方式] |
| **タイムアウト** | [秒] |
| **リトライ** | [回数、間隔] |
| **冪等性** | [対応可否] |

### 失敗パターン

| パターン | 想定状況 | システム挙動 | 復旧方法 |
|---------|---------|-------------|---------|
| Timeout | ネットワーク遅延 | [挙動] | [方法] |
| 5xx | サーバー障害 | [挙動] | [方法] |
| 4xx | 不正リクエスト | [挙動] | [方法] |
...
```

### 例：決済API

```markdown
# External IF Model: 決済システム

## IF一覧

### 決済API（Stripe）

| 項目 | 内容 |
|-----|------|
| **種別** | REST API |
| **エンドポイント** | https://api.stripe.com/v1/charges |
| **認証** | Bearer Token |
| **タイムアウト** | 30秒 |
| **リトライ** | 3回、指数バックオフ（1s, 2s, 4s） |
| **冪等性** | Idempotency-Key ヘッダー対応 |

### 失敗パターン

| パターン | 想定状況 | システム挙動 | 復旧方法 |
|---------|---------|-------------|---------|
| Timeout | ネットワーク遅延 | 決済状態を「確認中」に、リトライ | 手動確認後、確定/キャンセル |
| 500 | Stripe障害 | エラー表示、リトライ | Stripe復旧後リトライ |
| 402 | 残高不足 | エラー表示（残高不足） | 別決済手段を案内 |
| 400 | 不正パラメータ | エラー表示、ログ記録 | パラメータ修正 |
| 429 | レート制限 | キューイング、遅延実行 | 自動復旧 |
| 二重リクエスト | 同時クリック | Idempotency-Keyで重複排除 | 自動 |
| 部分完了 | 決済成功、DB更新失敗 | トランザクション補償 | 手動または定期バッチ |
```

---

## 5. リスクモデル

### 目的

失敗モード（何がどう壊れるか）を分析し、テスト優先度を決定する。

### テンプレート（FMEA形式）

```markdown
# Risk Model: [システム名]

## リスク一覧

| ID | 失敗モード | 影響 | 発生確率 | 影響度 | 検出難度 | RPN | テスト観点 |
|-----|----------|------|---------|-------|---------|-----|----------|
| R1 | [失敗内容] | [影響] | H/M/L | H/M/L | H/M/L | [数値] | [観点] |
...

※ RPN = 発生確率 × 影響度 × 検出難度（数値化して優先度付け）

## 詳細分析

### R1: [失敗モード名]

- **発生条件**: [どういう時に起きるか]
- **根本原因**: [なぜ起きるか]
- **影響範囲**: [誰に何が起きるか]
- **検出方法**: [どうやって気づくか]
- **予防策**: [どう防ぐか]
- **緩和策**: [起きた時どうするか]
- **テスト観点**: [何をテストすべきか]
```

### 例：ECサイト注文

```markdown
# Risk Model: ECサイト注文システム

## リスク一覧

| ID | 失敗モード | 影響 | 発生確率 | 影響度 | 検出難度 | RPN | テスト観点 |
|-----|----------|------|---------|-------|---------|-----|----------|
| R1 | 二重決済 | 顧客からのクレーム、返金コスト | M | H | M | 12 | 冪等性、同時リクエスト |
| R2 | 在庫不整合 | 欠品での注文キャンセル | H | M | L | 9 | 同時注文、在庫引当競合 |
| R3 | 決済失敗の誤検知 | 機会損失 | L | M | H | 6 | タイムアウト後の状態確認 |
| R4 | 個人情報漏洩 | 法的リスク、信用失墜 | L | H | H | 9 | ログ出力、エラー画面 |

## 詳細分析

### R1: 二重決済

- **発生条件**: 決済ボタン連打、ネットワーク遅延での再送、ブラウザバック後の再実行
- **根本原因**: 冪等性制御の欠如、クライアント側の制御不足
- **影響範囲**: 顧客（過払い）、運営（返金対応コスト）
- **検出方法**: 決済ログ監視、顧客からの問い合わせ
- **予防策**: Idempotency-Key、クライアント側の二重送信防止、DB側の一意制約
- **緩和策**: 自動検出して即時返金、サポート対応
- **テスト観点**:
  - ボタン連打（100ms間隔で10回）
  - 決済中のブラウザリロード
  - タイムアウト後のリトライ
  - 同一セッションからの同時リクエスト
```
