# Review Hybrid ガイド

ELD v2.3 のレビュー方式。Artifact-Based Review と行レビューのハイブリッド。

## 概要

すべてのPRに対してArtifact-Based Reviewを実施し、特定領域は追加で行レビューを行う。

```
全PR → Artifact-Based Review
         ↓
       行レビュー必須領域に該当?
         ├─ Yes → + 行レビュー
         └─ No  → Artifact-Based のみで完了
```

## Artifact-Based Review

Evidence Pack（証拠パック）をアーティファクトとして評価するレビュー方式。

### チェック項目

1. **Evidence Ladder達成レベル**
   - [ ] Severityに応じたLevelに到達しているか
   - [ ] L0だけで完了扱いしていないか

2. **Evaluator Quality**
   - [ ] Severity↔E要件を満たしているか
   - [ ] S0+セキュリティはE3を達成しているか
   - [ ] changed-lines coverageが確認されているか（E2要件時）

3. **Law/Term整合性**
   - [ ] 関連Lawの接地状況が記載されているか
   - [ ] 孤立したLaw/Termがないか
   - [ ] Link Mapが更新されているか

4. **テスト結果**
   - [ ] 全テストが通過しているか
   - [ ] 新規テストが追加されているか（必要な場合）

5. **カバレッジ**
   - [ ] changed-lines coverageが要件を満たすか

6. **影響範囲**
   - [ ] Predict-Light判定が適切か
   - [ ] 依存先への影響が確認されているか
   - [ ] 意図しない副作用がないか

7. **Context Delta**
   - [ ] 意思決定の理由が記録されているか
   - [ ] 学びやパターンが記録されているか

### 判定基準

```
Artifact-Based Review PASS:
  ✅ Evidence Ladder要件を満たす
  ✅ Evaluator Quality要件を満たす
  ✅ 全テスト通過
  ✅ Law/Term孤立なし
  ✅ 影響範囲が明確

Artifact-Based Review FAIL:
  ❌ 上記のいずれかを満たさない → 修正を要求
```

## 行レビュー必須領域

以下の領域の変更は、Artifact-Based Reviewに加え、コード行単位の詳細レビューが**必須**。

### 1. セキュリティ

**対象**: 認証/認可/暗号化に関するコード変更

**チェック観点**:
- 入力検証（SQLインジェクション、XSS、コマンドインジェクション）
- エスケープ処理
- 権限チェック（認可バイパスの有無）
- 暗号化（アルゴリズム選択、鍵管理）
- シークレット管理（ハードコード禁止）

### 2. 並行処理

**対象**: ロック/トランザクション/競合状態に関するコード変更

**チェック観点**:
- ロック順序（デッドロック防止）
- トランザクション分離レベル
- 競合状態（TOCTOU）
- アトミック性の保証

### 3. 永続化

**対象**: DBマイグレーション/スキーマ変更

**チェック観点**:
- マイグレーションの安全性（ダウンタイムなし）
- ロールバック可能性
- データ整合性の維持
- インデックス戦略

### 4. 認証

**対象**: トークン/セッション管理のコード変更

**チェック観点**:
- トークン検証の完全性
- セッション固定攻撃の防止
- 有効期限の適切性
- ログアウト処理の完全性

### 5. マイグレーション

**対象**: データ移行/後方互換に関するコード変更

**チェック観点**:
- 段階的移行の設計
- フォールバック機構
- 旧データの互換性
- 移行の冪等性

### 6. 課金

**対象**: 金額計算/決済処理のコード変更

**チェック観点**:
- 丸め処理の正確性
- 通貨換算の処理
- 冪等性（二重課金防止）
- 監査ログの出力

## レビュー方式の決定フロー

```
1. PRの変更ファイルを確認
2. 行レビュー必須領域に該当するか判定:
   - セキュリティ関連ファイル（auth/, security/, crypto/）
   - 並行処理（lock, mutex, transaction, semaphore）
   - 永続化（migration/, schema/）
   - 認証（auth/, token/, session/）
   - マイグレーション（migration/, data-transfer/）
   - 課金（billing/, payment/, pricing/）
3. 該当する場合:
   → Artifact-Based Review + 行レビュー
   → 行レビュー必須領域にフォーカスして詳細確認
4. 該当しない場合:
   → Artifact-Based Review のみ
```

## Evaluator Quality × Review Hybrid

| E Level | Artifact-Based | 行レビュー | 独立レビュー |
|---------|---------------|-----------|-------------|
| E0 | - | - | - |
| E1 | 必須 | 必須領域のみ | - |
| E2 | 必須 | 必須領域のみ | - |
| E3 | 必須 | 必須領域 + 全変更行 | 必須（別担当/別AIモデル） |

## よくある見落とし

1. **設定ファイル経由のセキュリティ変更**: コードは変わらないが設定で認証がバイパスされる
2. **暗黙のトランザクション境界**: フレームワークが自動管理するトランザクションの変更
3. **間接的な課金影響**: 割引ロジックやクーポン処理の変更
4. **依存ライブラリの脆弱性**: パッケージ更新に含まれるセキュリティ修正
