# Predict-Light（予測ゲート）

変更の影響度を自動判定し、適切な検証深度を決定するゲート機構。

> v2.3: 旧「Predict」フェーズを軽量ゲートに再設計。
> フルPredictは廃止し、P0/P1/P2の3段階で必要十分な予測を行う。

## 目的

- 変更の影響度に応じた最適な検証深度を決定
- 過剰な分析（P0変更にフル影響分析）を排除
- 過少な分析（P2変更を素通り）を防止
- ゲートとして Change フェーズ前に自動実行

## P0/P1/P2 段階定義

### P2: フル影響分析が必要

**判定条件（いずれかに該当）**:
- 公開API変更（外部に露出するインターフェースの変更）
- DB変更（スキーマ変更、マイグレーション）
- 認証認可変更（認証フロー、権限モデル）
- 課金ロジック変更（金額計算、決済処理）

**必要アウトプット**:
- フル影響分析テンプレート（→ `predict-light-template.md` P2）
- 段階化計画（ステップ分割+各ステップのロールバック方法）
- 停止条件（カスタム+標準）
- Evaluator Quality要件（E2以上推奨）

### P1: 影響リスト+停止条件

**判定条件（P2に該当せず、いずれかに該当）**:
- 複数ファイル変更
- テスト未カバー領域の変更
- 外部依存変更（ライブラリ、外部API）

**必要アウトプット**:
- 影響ファイルリスト
- 停止条件（標準）
- 簡易リスク評価

### P0: 3行要約のみ

**判定条件**:
- P1/P2のいずれにも該当しない

**必要アウトプット**:
- 3行以内の変更要約
- （停止条件は標準セットを暗黙適用）

## 機械判定ロジック

```
function predictLevel(change):
  // P2チェック
  if change.touchesPublicAPI:       return P2
  if change.touchesDBSchema:        return P2
  if change.touchesAuth:            return P2
  if change.touchesBilling:         return P2

  // P1チェック
  if change.filesChanged > 1:       return P1
  if change.hasUncoveredLines:      return P1
  if change.touchesExternalDeps:    return P1

  // デフォルト
  return P0
```

**判定に使用するシグナル**:
- `git diff --stat`: 変更ファイル数
- `grep -r "public\|export"`: 公開API検出
- `grep -r "migration\|schema"`: DB変更検出
- テストカバレッジレポート: 未カバー領域検出

## Manual Override

自動判定は誤分類の可能性がある。以下の場合はマニュアルオーバーライドを使用:

- **昇格**: P0→P1, P1→P2（「この変更は影響が大きい」）
- **降格**: P2→P1, P1→P0（「この変更は自動判定より安全」）

オーバーライド時はその理由を記録する。

## 週次監査

P0/P1/P2の分類精度を週次で監査:

1. 先週のP0変更で問題が発生しなかったか確認
2. P1/P2変更で過剰だったケースを特定
3. 誤分類パターンを判定ロジックにフィードバック

## 停止条件（標準セット）

以下はP0含む全レベルで暗黙適用:

1. **予測と現実の継続的乖離**: 想定外のテスト失敗が3回以上
2. **観測不能な変更の増加**: 物差しで検証できない変更が増える
3. **ロールバック線の崩壊**: 戻せない変更が発生

## 反射の選択

変更後の診断結果に応じて、適切な反射を選択:

### 機械反射（自動対応）
- 型エラー → 型を修正
- lint警告 → フォーマット修正
- 未使用変数 → 削除

### 設計反射（判断が必要）
- テスト失敗 → 原因分析と修正方針決定
- 依存関係の問題 → アーキテクチャ検討
- 性能劣化 → 最適化戦略の検討

## テンプレートリファレンス

→ `predict-light-template.md` にP0/P1/P2ごとのテンプレートあり

## チェックリスト

- [ ] P0/P1/P2の判定を実施したか
- [ ] 判定レベルに応じたアウトプットを作成したか
- [ ] Manual Override時は理由を記録したか
- [ ] 停止条件を確認したか（P1/P2は明示、P0は暗黙）
