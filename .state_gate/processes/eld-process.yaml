# =================================================================
# ELD (Evidence-Loop Development) Process Definition
# =================================================================
# state_gate で ELD の状態遷移を管理し、各フェーズで適切なスキルを
# 自動参照させるためのプロセス定義。
#
# ELD Loop: Sense -> Model -> Predict -> Change -> Ground -> Record
# =================================================================

process_id: eld-development
version: "1.1.0"
description: |
  Evidence-Loop Development プロセス。
  対話による要件明確化とエビデンス駆動の開発を統合。
  証拠で回す統合開発手法をstate_gateで制御。

initial_state: idle

# =================================================================
# 状態定義
# =================================================================
states:
  # -----------------------------------------------------------------
  # Idle: 待機状態
  # -----------------------------------------------------------------
  - name: idle
    description: タスク開始前の待機状態
    prompt: |
      ELD開発プロセスを開始する準備ができています。

      タスクが与えられたら、まず `/ai-led-onboarding` で作戦ブリーフを作成してください。
      これにより、最小スキーマ（目的・境界・不変条件・壊れ方・観測・未確定）を構築します。
    required_artifacts: []
    tool_permissions:
      allow: ["Read", "Glob", "Grep"]
      require_confirmation: ["WebSearch"]
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Onboard: オンボーディングフェーズ
  # -----------------------------------------------------------------
  - name: onboard
    description: |
      人間が最小スキーマを短時間で再構築するフェーズ。
      AIが進行役として質問し、理解を確立する。
    prompt: |
      ## Onboardフェーズ - 作戦ブリーフ作成

      **必須スキル**: `/ai-led-onboarding` - AIが進行役として最小スキーマを構築

      ### 合格条件（6点すべて必要）
      1. **目的**: この作業で何を成立させたいか（何が"成功"か）
      2. **境界**: どこを触り、どこは触らないか（責務と依存の境界）
      3. **不変条件**: 壊してはいけない条件（最大3つに圧縮）
      4. **壊れ方仮説**: 起きやすい/致命的/気づきにくい の3種
      5. **観測・検証**: 壊れたらどこで検知し、着手前に何を確かめるか
      6. **未確定リスト**: まだ分かっていないことと、その解消手段

      ### ガードレール
      - 根拠がない断言をしない
      - 不確実性は明示する
      - 長文で安心させない

      ### 完了条件
      - `.state_gate/artifacts/briefing.yaml` が作成されている
      - 人間が6点を説明できる状態
    required_artifacts:
      - path: ".state_gate/artifacts/briefing.yaml"
        description: 作戦ブリーフ（最小スキーマ）
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "WebSearch", "WebFetch"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Sense: 感知フェーズ
  # -----------------------------------------------------------------
  - name: sense
    description: |
      コンテキスト収集と要件明確化のフェーズ。
      対話を通じて曖昧さを解消する。
    prompt: |
      ## Senseフェーズ - コンテキスト構築 & 要件明確化

      ### 対話スキル（曖昧さがある場合）

      **`/eld-sense-requirements-brainstorming`** - 要件を対話的に明確化
      - Law/Term観点、境界条件、失敗モードから質問生成
      - Issue Contract下書き作成
      - 「適切に」「柔軟に」などの曖昧語を具体化

      **`/resolving-uncertainty`** - 不確実性を台帳化（任意タイミングで使用可）
      - Uncertainty Registerで外在化
      - 観測タスク（実験/計測/調査）に落とす

      ### コンテキスト構築スキル

      **必須**: `/eld-sense-activation` - アクティブコンテキスト構築
      - Goal: タスクの真の目的を3行以内で言語化
      - Constraints: セキュリティ/性能/互換性要件
      - References: 関連ドキュメント・既存コード

      **オプション**:
      - `/eld-sense-task-decomposition` - タスク分解（大きなタスク用）
      - `/eld-sense-scope` - サブタスクのスコープ管理
      - `/eld-sense-parallel-orchestrator` - 並列タスク調整

      ### 完了条件
      - `.state_gate/artifacts/active-context.yaml` が作成されている
      - 曖昧な要件がすべて具体化されている
      - 未確定事項が明示されている
    required_artifacts:
      - path: ".state_gate/artifacts/active-context.yaml"
        description: アクティブコンテキスト定義
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "WebSearch", "WebFetch"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Model: モデル化フェーズ
  # -----------------------------------------------------------------
  - name: model
    description: |
      Law（守るべき条件）とTerm（語彙）を定義するフェーズ。
      名辞抽象と関係抽象を行う。
    prompt: |
      ## Modelフェーズ - Law/Term定義

      ### 探索スキル
      **`/eld-model-law-discovery`** - 既存コードからLaw/Termを発見
      - 型定義、Zodスキーマ、アサーションから抽出
      - High Confidence項目を優先的にカード化

      ### 定義スキル
      **`/eld-model-law-card`** - Law（守るべき条件）をカード化
      - Type: Pre/Post/Invariant/Policy
      - Severity: S0（致命的）～S3（低）

      **`/eld-model-term-card`** - Term（語彙）をカード化
      - 境界、観測写像、値制約

      ### 検証スキル
      **`/eld-model-link-map`** - Law ↔ Term相互参照を確認
      - 孤立（参照なし）がないか検証

      ### 完了条件
      - 関連Law/TermがCatalogに登録されている
      - Link Mapに孤立がない
      - `.state_gate/artifacts/law-term-snapshot.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/law-term-snapshot.yaml"
        description: 関連Law/Termのスナップショット
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: ["Bash"]
      deny: []

  # -----------------------------------------------------------------
  # Predict: 予測フェーズ
  # -----------------------------------------------------------------
  - name: predict
    description: |
      変更の影響を予測し、段階化計画を策定するフェーズ。
    prompt: |
      ## Predictフェーズ - 影響予測

      **必須スキル**: `/eld-predict-impact` - 影響予測と段階化計画

      ### 分析項目
      1. **因果タイプ分類**: 互換性/性能/信頼性/セキュリティ/可観測性
      2. **直接影響 + 間接影響**: 依存先への伝播を追跡
      3. **unknown（追跡困難）の明示**: DI/IoC、設定ファイル、リフレクション等
      4. **リスクレベル評価**: Low/Medium/High/Critical

      ### 段階化計画
      - 危険度に応じた段階数: Low:1, Medium:2-3, High:3-5, Critical:5+
      - 各ステップでロールバック可能
      - 各ステップで検証方法を明記

      ### 停止条件の設定
      - 想定外テスト失敗3回
      - ロールバック不可能な状態
      - セキュリティ脆弱性発見
      - 観測不能な変更の増加

      ### 完了条件
      - `.state_gate/artifacts/impact-prediction.yaml` が作成されている
      - 段階化計画が人間に承認されている
    required_artifacts:
      - path: ".state_gate/artifacts/impact-prediction.yaml"
        description: 影響予測レポート
    tool_permissions:
      allow: ["Read", "Glob", "Grep"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Test Design: テスト設計フェーズ（新規追加）
  # -----------------------------------------------------------------
  - name: test_design
    description: |
      Law/Term駆動でテスト設計を行うフェーズ。
      Evidence Ladderに基づいて体系的にテストを設計する。
    prompt: |
      ## Test Designフェーズ - テスト設計

      **目的**: 実装前にテスト設計を完了させ、TDDの「RED」を準備する

      ### テスト設計監査（全体フレーム）
      **`/test-design-audit`** - Law/Term駆動のテスト設計監査
      - Phase 0: コンテキストパック収集 + pce-memory活性化
      - Phase 1: 要求の棚卸し（REQ-xxx）+ Law/Term対応付け
      - Phase 2: モデル化（5つのモデル + Law/Term視点）
      - Phase 3: カバレッジ基準策定 + Evidence Ladder
      - Phase 4: テスト条件ツリー（TCND-xxx）+ Law Grounding
      - Phase 5: 監査（複数視点 + Law違反チェック）
      - Phase 6: テスト項目生成（TEST-xxx）+ Grounding Map連携
      - Phase 7: トレーサビリティ検証 + Law/Term紐付け

      ### 体系的テスト設計（ユニット+PBT）
      **`/systematic-test-design`** - ユニットテストとPBTの統合設計
      - Phase 1: Law/Termからテスト対象を特定
      - Phase 2: ユニットテスト設計（典型例・境界例・回帰例）
      - Phase 3: プロパティ分類（7カテゴリ）
      - Phase 4: ジェネレータ設計（意地悪レベルL0-L8）

      ### Evidence Ladder対応
      | Level | 検証内容 | テスト種別 |
      |-------|----------|------------|
      | L0 | 静的整合 | 型チェック、Lint |
      | L1 | 単体での成立 | ユニットテスト、PBT L0-L2 |
      | L2 | 連携での成立 | 統合テスト、PBT L3-L5 |
      | L3 | 異常時の維持 | 失敗注入、PBT L6-L7 |
      | L4 | 実運用での成立 | 本番Telemetry |

      ### Law Severity別の必須レベル
      | Severity | 必須レベル |
      |----------|------------|
      | S0（致命的） | L0 + L1 + L2 + L3 |
      | S1（重要） | L0 + L1 + L2 |
      | S2（中程度） | L0 + L1 |
      | S3（低） | L0 |

      ### 成果物
      - requirements.md: 要求一覧 + Law/Term対応
      - test-conditions.md: テスト条件ツリー（TCND-xxx）
      - test-cases.md: テスト項目一覧（TEST-xxx）
      - properties.yaml: PBTプロパティカタログ
      - generators/: ジェネレータ群

      ### 完了条件
      - 全S0/S1 Lawにテスト条件が対応付けられている
      - Evidence Ladderの必須レベルが設計されている
      - `.state_gate/artifacts/test-design.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/test-design.yaml"
        description: テスト設計サマリ
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: ["Bash"]
      deny: []

  # -----------------------------------------------------------------
  # Change: 変更フェーズ
  # -----------------------------------------------------------------
  - name: change
    description: |
      段階化計画に従って実装を行うフェーズ。
      Test Designフェーズで設計したテストを先に書く（TDD）。
    prompt: |
      ## Changeフェーズ - 実装

      **前提**:
      - Predictフェーズの段階化計画に従う
      - Test Designフェーズで設計したテストを活用

      ### 高リスク変更時
      **`/eld-change-worktree`** - git worktreeで隔離環境を作成
      - 安全に実験・検証
      - マージ戦略を事前に決定

      ### TDD実践
      **`/eld-ground-tdd-enforcer`** - TDDサイクル強制
      - **RED**: Test Designで設計したテストを先に書く
      - **GREEN**: 最小限の実装
      - **REFACTOR**: リファクタリング

      **`/systematic-test-design`** - 必要に応じて追加テスト設計
      - ユニットテスト: 典型例・境界例
      - PBT: プロパティ + ジェネレータ
      - 反例発見時は即座に回帰テスト化

      ### 実装ルール
      - 最小単位で変更し、即時検証
      - 観測不能な変更を防ぐ
      - ロールバック可能な状態を維持
      - **テストなし実装を許さない**

      ### 停止反射
      停止条件に達したら即座に停止し、ユーザーに確認:
      - 想定外テスト失敗3回以上
      - セキュリティ脆弱性発見
      - 重大な設計変更が必要

      ### 完了条件
      - 全ステップの実装完了
      - 各ステップでテスト通過
      - 反例があれば回帰テストに回収済み
      - `.state_gate/artifacts/change-log.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/change-log.yaml"
        description: 変更ログ（各ステップの記録）
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write", "Bash"]
      require_confirmation: []
      deny: []

  # -----------------------------------------------------------------
  # Ground: 接地フェーズ
  # -----------------------------------------------------------------
  - name: ground
    description: |
      変更の品質を検証するフェーズ。
      Law/Termが正しく接地されているか確認。
    prompt: |
      ## Groundフェーズ - 接地検証

      ### 必須スキル
      **`/eld-ground-check`** - Law/Term接地検証
      - S0/S1は検証手段・観測手段必須
      - 相互拘束チェック（孤立なし）

      **`/eld-ground-evaluate`** - 出力品質評価
      - Evidence Ladder達成レベル確認
      - Law遵守チェック

      ### テスト監査（Test Designの検証）
      **`/test-design-audit`** - テスト設計の監査（Phase 5: 監査）
      - 全てのLaw/Termに対してテスト条件が存在するか
      - Law Severityに応じたEvidence Ladderレベルを満たしているか
      - Law違反時の動作がテストされているか

      ### PR準備
      **`/eld-ground-pre-completion`** - 完成前チェックリスト
      - Evidence Pack完全性
      - Law/Term孤立チェック
      - Evidence Ladder達成レベル

      ### オプション
      - `/eld-ground-tdd-enforcer` - TDDサイクル強制
      - `/eld-ground-law-monitor` - 実行時Law違反監視
      - `/eld-ground-pr-review` - PRレビュー
      - `/systematic-test-design` - 追加テスト（PBT反例回収）

      ### 接地要件
      | Severity | 検証手段 | 観測手段 |
      |----------|---------|---------|
      | S0 | **必須** (Test + Runtime) | **必須** (Telemetry全量) |
      | S1 | **必須** (Test or Runtime) | **必須** (Telemetry) |
      | S2 | 推奨 | 推奨 |
      | S3 | 任意 | 任意 |

      ### 完了条件
      - すべてのS0/S1 Law/Termが接地
      - Evidence Ladder目標レベル達成
      - 孤立Law/Termなし
      - `.state_gate/artifacts/grounding-report.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/grounding-report.yaml"
        description: 接地検証レポート
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash"]
      require_confirmation: ["Edit", "Write"]
      deny: []

  # -----------------------------------------------------------------
  # Record: 記録フェーズ
  # -----------------------------------------------------------------
  - name: record
    description: |
      知見を記録し、次のループに活かすフェーズ。
    prompt: |
      ## Recordフェーズ - 知識記録

      ### 必須スキル
      **`/eld-record-collection`** - Context Delta収集
      - 意思決定の痕跡（what/why/alternatives/trade_offs）
      - エラー解決策（symptom/root_cause/solution/prevention）
      - パターン発見（name/context/problem/solution）

      ### オプション
      - `/eld-record-structuring` - CLAUDE.md/ADR整理
      - `/eld-record-compact` - 長期セッションの圧縮
      - `/eld-record-knowledge-transfer` - 引き継ぎ資料作成
      - `/eld-record-maintenance` - 既存Claim整理
      - `/eld-record-memory-collector` - pce-memory収集

      ### 記録先の選択
      | 知見の種類 | 出力先 |
      |-----------|--------|
      | 即時参照が必要 | pce-memory (upsert) |
      | アーキテクチャ決定 | docs/adr/ |
      | プロジェクト共通 | ルートCLAUDE.md |
      | ドメイン固有 | 該当フォルダのCLAUDE.md |

      ### 完了条件
      - 重要な意思決定が記録されている
      - pce-memoryが更新されている
      - `.state_gate/artifacts/record-summary.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/record-summary.yaml"
        description: 記録サマリ
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: []
      deny: ["Bash"]

  # -----------------------------------------------------------------
  # Blocked: ブロック状態
  # -----------------------------------------------------------------
  - name: blocked
    description: |
      不確実性や未解決の質問によりブロックされた状態。
      対話を通じて解消する。
    prompt: |
      ## Blockedフェーズ - 不確実性の解消

      **必須スキル**: `/resolving-uncertainty` - 不確実性の台帳化と観測計画

      ### 手順
      1. **Frame the decision**: 決めたいこと・期限・失敗時の損失・制約
      2. **Itemize uncertainties**: 不確実性を疑問文で列挙（10個まで）
      3. **Rank**: Priority = Impact × (6-Evidence) × Urgency ÷ Effort
      4. **Convert to observation tasks**: 上位N（3-5）を観測タスクに

      ### 観測タスク必須要素
      - **Hypothesis**: 仮説
      - **Method**: 観測方法（現物/証拠/知識）
      - **Timebox**: 上限時間
      - **Decision rule**: 採用/撤回の条件
      - **Evidence artifact**: ログ/スクショ/計測結果

      ### 完了条件
      - 上位N（3-5）の不確実性に対する観測タスクが定義
      - 観測を実行し、Evidenceを記録
      - `.state_gate/artifacts/uncertainty-register.yaml` が作成されている
    required_artifacts:
      - path: ".state_gate/artifacts/uncertainty-register.yaml"
        description: 不確実性台帳
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash", "WebSearch", "WebFetch"]
      require_confirmation: ["Edit", "Write"]
      deny: []

  # -----------------------------------------------------------------
  # Complete: 完了状態
  # -----------------------------------------------------------------
  - name: complete
    description: タスク完了
    prompt: |
      ## タスク完了

      ELDループが正常に完了しました。

      ### 成果物一覧
      - briefing.yaml: 作戦ブリーフ
      - active-context.yaml: アクティブコンテキスト
      - law-term-snapshot.yaml: Law/Termスナップショット
      - impact-prediction.yaml: 影響予測
      - change-log.yaml: 変更ログ
      - grounding-report.yaml: 接地検証レポート
      - record-summary.yaml: 記録サマリ

      ### 次のアクション
      - PR作成: `/create-pr`
      - 新しいタスク: 次のIssueへ
      - 反復: 改善点があれば再度Senseフェーズへ
    required_artifacts: []
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash"]
      require_confirmation: ["Edit", "Write"]
      deny: []

# =================================================================
# 遷移定義
# =================================================================
transitions:
  # idle -> onboard
  - from: idle
    event: start_task
    to: onboard
    guards: []

  # onboard -> sense
  - from: onboard
    event: briefing_ready
    to: sense
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/briefing.yaml"

  # sense -> model
  - from: sense
    event: context_ready
    to: model
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/active-context.yaml"

  # model -> predict
  - from: model
    event: model_ready
    to: predict
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/law-term-snapshot.yaml"

  # predict -> test_design (人間の承認が必要)
  - from: predict
    event: plan_approved
    to: test_design
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/impact-prediction.yaml"
      - type: manual_approval
        approver: human

  # test_design -> change
  - from: test_design
    event: test_design_ready
    to: change
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/test-design.yaml"

  # change -> ground
  - from: change
    event: implementation_done
    to: ground
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/change-log.yaml"

  # ground -> record
  - from: ground
    event: grounding_passed
    to: record
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/grounding-report.yaml"
      - type: custom
        name: s0_s1_grounded
        description: S0/S1 Law/Termがすべて接地されているか確認

  # record -> complete
  - from: record
    event: record_done
    to: complete
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/record-summary.yaml"

  # complete -> sense (反復)
  - from: complete
    event: iterate
    to: sense
    guards:
      - type: manual_approval
        approver: human

  # -----------------------------------------------------------------
  # 不確実性発生時の遷移 (任意フェーズ -> blocked)
  # -----------------------------------------------------------------
  - from: onboard
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: onboard

  - from: sense
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: sense

  - from: model
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: model

  - from: predict
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: predict

  - from: test_design
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: test_design

  - from: change
    event: uncertainty_detected
    to: blocked
    guards: []
    metadata:
      return_to: change

  # blocked -> 元のフェーズへ復帰
  - from: blocked
    event: uncertainty_resolved
    to: sense  # デフォルト。実際はmetadataのreturn_toを参照
    guards:
      - type: artifact_exists
        path: ".state_gate/artifacts/uncertainty-register.yaml"

  # -----------------------------------------------------------------
  # 後退遷移（問題発見時）
  # -----------------------------------------------------------------
  - from: ground
    event: grounding_failed
    to: change
    guards: []

  - from: change
    event: stop_condition_hit
    to: predict
    guards: []

  - from: model
    event: requirements_unclear
    to: sense
    guards: []

  - from: predict
    event: scope_change_needed
    to: sense
    guards: []

# =================================================================
# ロール定義
# =================================================================
roles:
  agent:
    description: AI Agent (Claude Code)
    allowed_events:
      - start_task
      - briefing_ready
      - context_ready
      - model_ready
      - test_design_ready
      - implementation_done
      - grounding_passed
      - grounding_failed
      - record_done
      - stop_condition_hit
      - requirements_unclear
      - scope_change_needed
      - uncertainty_detected
      - uncertainty_resolved

  human:
    description: Human supervisor
    allowed_events:
      - plan_approved
      - iterate
      - override  # 強制遷移（緊急時）
