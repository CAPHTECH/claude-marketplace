# =================================================================
# ELD (Evidence-Loop Development) Process Definition
# =================================================================
# state_gate で ELD の状態遷移を管理し、各フェーズで適切なスキルを
# 自動参照させるためのプロセス定義。
#
# ELD Loop: Sense -> Model -> Predict -> Change -> Ground -> Record
# =================================================================

process:
  id: eld-process
  version: "1.1.0"
  name: ELD Development Process
  description: |
    Evidence-Loop Development プロセス。
    対話による要件明確化とエビデンス駆動の開発を統合。
    証拠で回す統合開発手法をstate_gateで制御。
  initial_state: idle
  initial_context:
    evidence_level: L0
    iteration: 0

# =================================================================
# 状態定義
# =================================================================
states:
  # -----------------------------------------------------------------
  # Idle: 待機状態
  # -----------------------------------------------------------------
  - name: idle
    description: タスク開始前の待機状態
    prompt: |
      ELD開発プロセスを開始する準備ができています。

      タスクが与えられたら、まず `/ai-led-onboarding` で作戦ブリーフを作成してください。
      これにより、最小スキーマ（目的・境界・不変条件・壊れ方・観測・未確定）を構築します。
    tool_permissions:
      allow: ["Read", "Glob", "Grep"]
      require_confirmation: ["WebSearch"]
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Onboard: オンボーディングフェーズ
  # -----------------------------------------------------------------
  - name: onboard
    description: |
      人間が最小スキーマを短時間で再構築するフェーズ。
      AIが進行役として質問し、理解を確立する。
    prompt: |
      ## Onboardフェーズ - 作戦ブリーフ作成

      **必須スキル**: `/ai-led-onboarding` - AIが進行役として最小スキーマを構築

      ### 合格条件（6点すべて必要）
      1. **目的**: この作業で何を成立させたいか（何が"成功"か）
      2. **境界**: どこを触り、どこは触らないか（責務と依存の境界）
      3. **不変条件**: 壊してはいけない条件（最大3つに圧縮）
      4. **壊れ方仮説**: 起きやすい/致命的/気づきにくい の3種
      5. **観測・検証**: 壊れたらどこで検知し、着手前に何を確かめるか
      6. **未確定リスト**: まだ分かっていないことと、その解消手段

      ### ガードレール
      - 根拠がない断言をしない
      - 不確実性は明示する
      - 長文で安心させない

      ### 完了条件
      - `.state_gate/artifacts/briefing.yaml` が作成されている
      - 人間が6点を説明できる状態
    required_artifacts:
      - briefing
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "WebSearch", "WebFetch"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Sense: 感知フェーズ
  # -----------------------------------------------------------------
  - name: sense
    description: |
      コンテキスト収集と要件明確化のフェーズ。
      対話を通じて曖昧さを解消する。
    prompt: |
      ## Senseフェーズ - コンテキスト構築 & 要件明確化

      ### 対話スキル（曖昧さがある場合）

      **`/eld-sense-requirements-brainstorming`** - 要件を対話的に明確化
      - Law/Term観点、境界条件、失敗モードから質問生成
      - Issue Contract下書き作成
      - 「適切に」「柔軟に」などの曖昧語を具体化

      **`/resolving-uncertainty`** - 不確実性を台帳化（任意タイミングで使用可）
      - Uncertainty Registerで外在化
      - 観測タスク（実験/計測/調査）に落とす

      ### コンテキスト構築スキル

      **必須**: `/eld-sense-activation` - アクティブコンテキスト構築
      - Goal: タスクの真の目的を3行以内で言語化
      - Constraints: セキュリティ/性能/互換性要件
      - References: 関連ドキュメント・既存コード

      **オプション**:
      - `/eld-sense-task-decomposition` - タスク分解（大きなタスク用）
      - `/eld-sense-scope` - サブタスクのスコープ管理
      - `/eld-sense-parallel-orchestrator` - 並列タスク調整

      ### 完了条件
      - `.state_gate/artifacts/active-context.yaml` が作成されている
      - 曖昧な要件がすべて具体化されている
      - 未確定事項が明示されている
    required_artifacts:
      - active-context
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "WebSearch", "WebFetch"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Model: モデル化フェーズ
  # -----------------------------------------------------------------
  - name: model
    description: |
      Law（守るべき条件）とTerm（語彙）を定義するフェーズ。
      名辞抽象と関係抽象を行う。
    prompt: |
      ## Modelフェーズ - Law/Term定義

      ### 探索スキル
      **`/eld-model-law-discovery`** - 既存コードからLaw/Termを発見
      - 型定義、Zodスキーマ、アサーションから抽出
      - High Confidence項目を優先的にカード化

      ### 定義スキル
      **`/eld-model-law-card`** - Law（守るべき条件）をカード化
      - Type: Pre/Post/Invariant/Policy
      - Severity: S0（致命的）～S3（低）

      **`/eld-model-term-card`** - Term（語彙）をカード化
      - 境界、観測写像、値制約

      ### 検証スキル
      **`/eld-model-link-map`** - Law ↔ Term相互参照を確認
      - 孤立（参照なし）がないか検証

      ### 完了条件
      - 関連Law/TermがCatalogに登録されている
      - Link Mapに孤立がない
      - `.state_gate/artifacts/law-term-snapshot.yaml` が作成されている
    required_artifacts:
      - law-term-snapshot
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: ["Bash"]
      deny: []

  # -----------------------------------------------------------------
  # Predict: 予測フェーズ
  # -----------------------------------------------------------------
  - name: predict
    description: |
      変更の影響を予測し、段階化計画を策定するフェーズ。
    prompt: |
      ## Predictフェーズ - 影響予測

      **必須スキル**: `/eld-predict-impact` - 影響予測と段階化計画

      ### 分析項目
      1. **因果タイプ分類**: 互換性/性能/信頼性/セキュリティ/可観測性
      2. **直接影響 + 間接影響**: 依存先への伝播を追跡
      3. **unknown（追跡困難）の明示**: DI/IoC、設定ファイル、リフレクション等
      4. **リスクレベル評価**: Low/Medium/High/Critical

      ### 段階化計画
      - 危険度に応じた段階数: Low:1, Medium:2-3, High:3-5, Critical:5+
      - 各ステップでロールバック可能
      - 各ステップで検証方法を明記

      ### 停止条件の設定
      - 想定外テスト失敗3回
      - ロールバック不可能な状態
      - セキュリティ脆弱性発見
      - 観測不能な変更の増加

      ### 完了条件
      - `.state_gate/artifacts/impact-prediction.yaml` が作成されている
      - 段階化計画が人間に承認されている
    required_artifacts:
      - impact-prediction
    tool_permissions:
      allow: ["Read", "Glob", "Grep"]
      require_confirmation: []
      deny: ["Edit", "Write", "Bash"]

  # -----------------------------------------------------------------
  # Test Design: テスト設計フェーズ
  # -----------------------------------------------------------------
  - name: test_design
    description: |
      Law/Term駆動でテスト設計を行うフェーズ。
      Evidence Ladderに基づいて体系的にテストを設計する。
    prompt: |
      ## Test Designフェーズ - テスト設計

      **目的**: 実装前にテスト設計を完了させ、TDDの「RED」を準備する

      ### テスト設計監査（全体フレーム）
      **`/test-design-audit`** - Law/Term駆動のテスト設計監査

      ### 体系的テスト設計（ユニット+PBT）
      **`/systematic-test-design`** - ユニットテストとPBTの統合設計

      ### Law Severity別の必須レベル
      | Severity | 必須レベル |
      |----------|------------|
      | S0（致命的） | L0 + L1 + L2 + L3 |
      | S1（重要） | L0 + L1 + L2 |
      | S2（中程度） | L0 + L1 |
      | S3（低） | L0 |

      ### 完了条件
      - 全S0/S1 Lawにテスト条件が対応付けられている
      - Evidence Ladderの必須レベルが設計されている
      - `.state_gate/artifacts/test-design.yaml` が作成されている
    required_artifacts:
      - test-design
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: ["Bash"]
      deny: []

  # -----------------------------------------------------------------
  # Change: 変更フェーズ
  # -----------------------------------------------------------------
  - name: change
    description: |
      段階化計画に従って実装を行うフェーズ。
      Test Designフェーズで設計したテストを先に書く（TDD）。
    prompt: |
      ## Changeフェーズ - 実装

      **前提**:
      - Predictフェーズの段階化計画に従う
      - Test Designフェーズで設計したテストを活用

      ### 高リスク変更時
      **`/eld-change-worktree`** - git worktreeで隔離環境を作成

      ### TDD実践
      **`/eld-ground-tdd-enforcer`** - TDDサイクル強制
      **`/systematic-test-design`** - 必要に応じて追加テスト設計

      ### 実装ルール
      - 最小単位で変更し、即時検証
      - 観測不能な変更を防ぐ
      - ロールバック可能な状態を維持
      - **テストなし実装を許さない**

      ### 停止反射
      停止条件に達したら即座に停止し、ユーザーに確認

      ### 完了条件
      - 全ステップの実装完了
      - 各ステップでテスト通過
      - `.state_gate/artifacts/change-log.yaml` が作成されている
    required_artifacts:
      - change-log
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write", "Bash"]
      require_confirmation: []
      deny: []

  # -----------------------------------------------------------------
  # Ground: 接地フェーズ
  # -----------------------------------------------------------------
  - name: ground
    description: |
      変更の品質を検証するフェーズ。
      Law/Termが正しく接地されているか確認。
    prompt: |
      ## Groundフェーズ - 接地検証

      ### 必須スキル
      **`/eld-ground-check`** - Law/Term接地検証
      **`/eld-ground-evaluate`** - 出力品質評価

      ### テスト監査
      **`/test-design-audit`** - テスト設計の監査

      ### PR準備
      **`/eld-ground-pre-completion`** - 完成前チェックリスト

      ### 接地要件
      | Severity | 検証手段 | 観測手段 |
      |----------|---------|---------|
      | S0 | **必須** | **必須** |
      | S1 | **必須** | **必須** |
      | S2 | 推奨 | 推奨 |
      | S3 | 任意 | 任意 |

      ### 完了条件
      - すべてのS0/S1 Law/Termが接地
      - Evidence Ladder目標レベル達成
      - `.state_gate/artifacts/grounding-report.yaml` が作成されている
    required_artifacts:
      - grounding-report
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash"]
      require_confirmation: ["Edit", "Write"]
      deny: []

  # -----------------------------------------------------------------
  # Record: 記録フェーズ
  # -----------------------------------------------------------------
  - name: record
    description: |
      知見を記録し、次のループに活かすフェーズ。
    prompt: |
      ## Recordフェーズ - 知識記録

      ### 必須スキル
      **`/eld-record-collection`** - Context Delta収集

      ### オプション
      - `/eld-record-structuring` - CLAUDE.md/ADR整理
      - `/eld-record-compact` - 長期セッションの圧縮
      - `/eld-record-knowledge-transfer` - 引き継ぎ資料作成

      ### 完了条件
      - 重要な意思決定が記録されている
      - `.state_gate/artifacts/record-summary.yaml` が作成されている
    required_artifacts:
      - record-summary
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Edit", "Write"]
      require_confirmation: []
      deny: ["Bash"]

  # -----------------------------------------------------------------
  # Blocked: ブロック状態
  # -----------------------------------------------------------------
  - name: blocked
    description: |
      不確実性や未解決の質問によりブロックされた状態。
    prompt: |
      ## Blockedフェーズ - 不確実性の解消

      **必須スキル**: `/resolving-uncertainty` - 不確実性の台帳化と観測計画

      ### 完了条件
      - 上位N（3-5）の不確実性に対する観測タスクが定義
      - `.state_gate/artifacts/uncertainty-register.yaml` が作成されている
    required_artifacts:
      - uncertainty-register
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash", "WebSearch", "WebFetch"]
      require_confirmation: ["Edit", "Write"]
      deny: []

  # -----------------------------------------------------------------
  # Complete: 完了状態
  # -----------------------------------------------------------------
  - name: complete
    description: タスク完了
    is_final: true
    prompt: |
      ## タスク完了

      ELDループが正常に完了しました。

      ### 次のアクション
      - PR作成: `/create-pr`
      - 新しいタスク: 次のIssueへ
    tool_permissions:
      allow: ["Read", "Glob", "Grep", "Bash"]
      require_confirmation: ["Edit", "Write"]
      deny: []

# =================================================================
# イベント定義
# =================================================================
events:
  - name: start_task
    description: タスクを開始する
    allowed_roles: [agent, human]

  - name: briefing_ready
    description: ブリーフィングが完了した
    allowed_roles: [agent]

  - name: context_ready
    description: コンテキスト構築が完了した
    allowed_roles: [agent]

  - name: model_ready
    description: Law/Term定義が完了した
    allowed_roles: [agent]

  - name: plan_approved
    description: 影響予測と計画が承認された
    allowed_roles: [human]

  - name: test_design_ready
    description: テスト設計が完了した
    allowed_roles: [agent]

  - name: implementation_done
    description: 実装が完了した
    allowed_roles: [agent]

  - name: grounding_passed
    description: 接地検証に合格した
    allowed_roles: [agent, system]

  - name: grounding_failed
    description: 接地検証に失敗した
    allowed_roles: [agent, system]

  - name: record_done
    description: 知識記録が完了した
    allowed_roles: [agent]

  - name: uncertainty_detected
    description: 不確実性によりブロックされた
    allowed_roles: [agent]

  - name: uncertainty_resolved
    description: ブロックが解消された
    allowed_roles: [agent, human]

  - name: iterate
    description: 反復する
    allowed_roles: [human]

  - name: stop_condition_hit
    description: 停止条件に達した
    allowed_roles: [agent]

  - name: requirements_unclear
    description: 要件が不明確
    allowed_roles: [agent]

  - name: scope_change_needed
    description: スコープ変更が必要
    allowed_roles: [agent]

  - name: override
    description: 強制遷移（緊急時）
    allowed_roles: [human]

# =================================================================
# ロール定義
# =================================================================
roles:
  - name: agent
    description: AI Agent (Claude Code)
    allowed_events:
      - start_task
      - briefing_ready
      - context_ready
      - model_ready
      - test_design_ready
      - implementation_done
      - grounding_passed
      - grounding_failed
      - record_done
      - stop_condition_hit
      - requirements_unclear
      - scope_change_needed
      - uncertainty_detected
      - uncertainty_resolved
    can_approve: false
    can_reject: false

  - name: human
    description: Human supervisor
    allowed_events:
      - start_task
      - plan_approved
      - iterate
      - uncertainty_resolved
      - override
    can_approve: true
    can_reject: true

  - name: system
    description: Automated system (CI)
    allowed_events:
      - grounding_passed
      - grounding_failed
    can_approve: false
    can_reject: false

# =================================================================
# 遷移定義
# =================================================================
transitions:
  # idle -> onboard
  - from: idle
    event: start_task
    to: onboard

  # onboard -> sense
  - from: onboard
    event: briefing_ready
    to: sense
    guard: artifact_briefing

  # sense -> model
  - from: sense
    event: context_ready
    to: model
    guard: artifact_active_context

  # model -> predict
  - from: model
    event: model_ready
    to: predict
    guard: artifact_law_term

  # predict -> test_design (人間の承認が必要)
  - from: predict
    event: plan_approved
    to: test_design
    guard: artifact_impact

  # test_design -> change
  - from: test_design
    event: test_design_ready
    to: change
    guard: artifact_test_design

  # change -> ground
  - from: change
    event: implementation_done
    to: ground
    guard: artifact_change_log

  # ground -> record
  - from: ground
    event: grounding_passed
    to: record
    guard: artifact_grounding

  # record -> complete
  - from: record
    event: record_done
    to: complete
    guard: artifact_record

  # complete -> sense (反復)
  - from: complete
    event: iterate
    to: sense

  # -----------------------------------------------------------------
  # 不確実性発生時の遷移
  # -----------------------------------------------------------------
  - from: onboard
    event: uncertainty_detected
    to: blocked

  - from: sense
    event: uncertainty_detected
    to: blocked

  - from: model
    event: uncertainty_detected
    to: blocked

  - from: predict
    event: uncertainty_detected
    to: blocked

  - from: test_design
    event: uncertainty_detected
    to: blocked

  - from: change
    event: uncertainty_detected
    to: blocked

  # blocked -> sense (復帰)
  - from: blocked
    event: uncertainty_resolved
    to: sense
    guard: artifact_uncertainty

  # -----------------------------------------------------------------
  # 後退遷移（問題発見時）
  # -----------------------------------------------------------------
  - from: ground
    event: grounding_failed
    to: change

  - from: change
    event: stop_condition_hit
    to: predict

  - from: model
    event: requirements_unclear
    to: sense

  - from: predict
    event: scope_change_needed
    to: sense

# =================================================================
# ガード定義
# =================================================================
guards:
  artifact_briefing:
    type: artifact
    artifact_type: briefing
    condition: exists

  artifact_active_context:
    type: artifact
    artifact_type: active-context
    condition: exists

  artifact_law_term:
    type: artifact
    artifact_type: law-term-snapshot
    condition: exists

  artifact_impact:
    type: artifact
    artifact_type: impact-prediction
    condition: exists

  artifact_test_design:
    type: artifact
    artifact_type: test-design
    condition: exists

  artifact_change_log:
    type: artifact
    artifact_type: change-log
    condition: exists

  artifact_grounding:
    type: artifact
    artifact_type: grounding-report
    condition: exists

  artifact_record:
    type: artifact
    artifact_type: record-summary
    condition: exists

  artifact_uncertainty:
    type: artifact
    artifact_type: uncertainty-register
    condition: exists

# =================================================================
# アーティファクト定義
# =================================================================
artifacts:
  - type: briefing
    description: 作戦ブリーフ（最小スキーマ）
    required_in_states: [onboard]

  - type: active-context
    description: アクティブコンテキスト
    required_in_states: [sense]

  - type: uncertainty-register
    description: 不確実性台帳
    required_in_states: [blocked]

  - type: law-term-snapshot
    description: Law/Termスナップショット
    required_in_states: [model]

  - type: impact-prediction
    description: 影響予測
    required_in_states: [predict]

  - type: test-design
    description: テスト設計サマリ
    required_in_states: [test_design]

  - type: change-log
    description: 変更ログ
    required_in_states: [change]

  - type: grounding-report
    description: 接地検証レポート
    required_in_states: [ground]

  - type: record-summary
    description: 知識記録サマリ
    required_in_states: [record]
